<!DOCTYPE html>
<html>
<style type="text/css">
body,
html {
    width: 100%;
    height: 100%
}

.pay {
    position: relative;
}

.loadzz {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0
}

.loading_k {
    position: absolute;
    top: 45%;
    left: 50%;
    width: 60px;
    height: 60px;
    margin: -30px 0 0 -30px;
    background: rgba(0, 0, 0, .5);
    border-radius: 10px
}

.loading_kz {
    width: 100px;
    height: 100px;
    margin: -50px 0 0 -50px;
}

.h3 {
    width: 300px;
    text-align: center;
    color: #fff;
    position: absolute;
    top: 65%;
    left: calc(50% - 150px);
    font-size: 18px
}

.loading {
    position: absolute;
    top: 50%;
    left: 50%;
    margin: -13px 0 0 -13px;
    width: 26px;
    height: 26px;
    border: 2px solid;
    border-color: #fff #fff transparent;
    border-radius: 50%;
    box-sizing: border-box;
    animation: loading 1s linear infinite
}

.loadingz {
    top: 35%;
    margin: -15px 0 0 -15px;
    width: 30px;
    height: 30px;
}

@keyframes loading {
    0% {
        transform: rotate(0)
    }

    100% {
        transform: rotate(360deg)
    }
}

input {
    border: none
}
.payNumBox{
    border-top: 1px solid rgba(153,153,153,1);
}
</style>
<script type="text/javascript">
var adiv = '<div id="loadstart" class="loadzz"><div class="loading_k"><div class="loading"></div></div></div>'
document.write(adiv)
</script>

<head>
    <meta charset="utf-8">
    <meta content="initial-scale=1.0,maximum-scale=1.0,width=device-width" name="viewport">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="telephone=no" name="format-detection">
    <meta content="email=no" name="format-detection">
    <link rel="stylesheet" href="./css/style-vip.css">
    <link rel="stylesheet" href="./css/qrPay.css?v=1.3">
    <title>向商户付款</title>
    <script src="js/jquery.min.js"></script>
    <script type="text/javascript">
    function getQueryString(name) {
        var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
        var r = decodeURIComponent(window.location.search).substr(1).match(reg);
        if (r != null) {
            return unescape(r[2]);
        }
        return null;
    }
    console.log(window.location.href)
    // var projectUrl = window.location.href.split('/oneCode')[0];
    var clientNumber = getQueryString('outTradeNo');
    var payNumber = getQueryString('payNumber');

    var aliCode, weixinCode, merchantNumber, merInfo;
    var oData = new Object()
    oData.equipmentNumber = clientNumber


    var payType
    var uull;
    var codeType
    var code, pay, data;
    var merNumber;
    var insNumber;
    var ip;
    var isVip, cardUrl
    var userInfo
    var payChoose = 0
    var cardEnabled =1
    document.getElementById('loadstart').style.display = "none";
    if (/MicroMessenger/.test(window.navigator.userAgent)) {
        document.addEventListener('WeixinJSBridgeReady', function onBridgeReady1() {
            // 通过下面这个API隐藏右上角按钮
            WeixinJSBridge.call('hideOptionMenu');
        });
        console.log(window.location.href)
        if (window.location.href.indexOf('code=') == -1) {
            sessionStorage.removeItem("userInfo");
            console.time('aaa');
            $.ajax({
                //url: "http://api-cs.51shanhe.com/p-server/appServer/getInfo",
                url: "https://api.51shanhe.com/p-server/appServer/getInfo",
                //url:"http://192.168.1.66:6017/p-server/appServer/getInfo",
                type: "POST",
                async: false,
                headers: {
                    "Content-Type": "application/json"
                },
                data: JSON.stringify(oData),
                success: function(data) {
                    if (data.code == 1000) {
                        console.timeEnd('aaa')
                        console.log(JSON.stringify(data))
                        cardEnabled = data.data.cardEnabled
                        // aliCode = JSON.parse(data.data.payBaseInfo).aliAppId;
                        // weixinCode = JSON.parse(data.data.payBaseInfo).wxAppId;
                        // merchantNumber = data.data.merchantNumber
                        merInfo = data.data
                        var ajData = new Object()
                        ajData.paymentType = 'WeChat_Pay'
                        ajData.merchantNumber = data.data.merchantNumber
                        ajData.equipmentNumber = clientNumber
                        ajData.shopNumber = data.data.storeId
                        ajData.clerkNumber = data.data.userNumber
                        ajData.codeType = 'PublicAddress_Pay'
                        console.time('bbb')
                        $.ajax({
                            //url: "http://api.51shanhe.com/p-server/appServer/getInfo",
                            url: "https://api.51shanhe.com/p-pay/pay/payRoute",
                            //url:"http://192.168.1.80:5008/p-pay/pay/payRoute",
                            type: "POST",
                            async: false,
                            headers: {
                                "Content-Type": "application/json"
                            },
                            data: JSON.stringify(ajData),
                            success: function(data) {
                                console.timeEnd('bbb')
                                //aliCode = JSON.parse(data.data.payBaseInfo).aliAppId;
                                //weixinCode = JSON.parse(data.data.payBaseInfo).wxAppId;
                                if(data.code != 1000){
                                    alert(data.msg)
                                    return
                                }
                                if(cardEnabled == 0){
                                    var scope = "auth_base";
                                    var redirect_uri = window.location.href + '&cardEnabled=' + cardEnabled;;
                                    window.location.href = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=" + data.data.appId + "&redirect_uri=" + encodeURIComponent(redirect_uri) + "&response_type=code&scope=snsapi_userinfo&state=start#wechat_redirect"
                                }else{
                                    var scope = "auth_base";
                                    var redirect_uri = window.location.href + '&cardEnabled=' + cardEnabled;
                                 
                                    window.location.href = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=" + data.data.appId + "&redirect_uri=" + encodeURIComponent(redirect_uri) + "&response_type=code&scope=snsapi_base&state=start#wechat_redirect"
                                }
                                
                            }
                        })
                    } else {
                        alert(data.msg)
                    }
                }
            })

        } else {

            code = window.location.href.split('code=')[1].split('&')[0];

            document.getElementById('loadstart').style.display = "none";
            console.log(!!JSON.parse(sessionStorage.getItem('userInfo')))
            if (!!JSON.parse(sessionStorage.getItem('userInfo'))) {
                merchantNumber = JSON.parse(sessionStorage.getItem('sInfo')).merchantNumber
                merInfo = JSON.parse(sessionStorage.getItem('sInfo'))

                if (JSON.parse(sessionStorage.getItem('userInfo')).code == 1000) {
                    isVip = false
                    cardUrl = JSON.parse(sessionStorage.getItem('userInfo')).data.getCardUrl
                    userInfo = JSON.parse(sessionStorage.getItem('userInfo')).data
                } else {
                    isVip = true
                    userInfo = JSON.parse(sessionStorage.getItem('userInfo')).data
                }
                console.log(userInfo)
            } else {
                $.ajax({
                    url: "https://api.51shanhe.com/p-server/appServer/getInfo",
                    //url:"http://192.168.1.80:6017/p-server/appServer/getInfo",
                    type: "POST",
                    async: false,
                    headers: {
                        "Content-Type": "application/json"
                    },
                    data: JSON.stringify(oData),
                    success: function(data) {
                        console.log(JSON.stringify(data))
                        // aliCode = JSON.parse(data.data.payBaseInfo).aliAppId;
                        // weixinCode = JSON.parse(data.data.payBaseInfo).wxAppId;
                        merchantNumber = data.data.merchantNumber
                        merInfo = data.data
                        if(getQueryString('cardEnabled') == 0){
                           var aData = new Object()
                            aData.merchantNumber = merchantNumber

                            aData.code = code
                            var ajData = new Object()
                            ajData.paymentType = 'WeChat_Pay'
                            ajData.merchantNumber = data.data.merchantNumber
                            ajData.equipmentNumber = clientNumber
                            ajData.shopNumber = data.data.storeId
                            ajData.clerkNumber = data.data.userNumber
                            ajData.codeType = 'PublicAddress_Pay'
                            $.ajax({
                                //url: "http://api.51shanhe.com/p-server/appServer/getInfo",
                                url: "https://api.51shanhe.com/p-pay/pay/payRoute",
                                //url:"http://192.168.1.80:5008/p-pay/pay/payRoute",   
                                type: "POST",
                                async: false,
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                data: JSON.stringify(ajData),
                                success: function(data) {
                                    aData.appId = data.data.appId
                                    $.ajax({
                                        url: "https://api.51shanhe.com/p-member/server/getMemInfo",
                                        //url:"http://192.168.1.80:6017/p-server/appServer/getInfo",
                                        type: "GET",
                                        async: false,
                                        headers: {
                                            "Content-Type": "application/json"
                                        },
                                        data: aData,
                                        success: function(data) {
                                            console.log(JSON.stringify(data))
                                            if (data.code == 1000) {
                                                if (data.data.getCardUrl == '') {

                                                } else {
                                                    isVip = false
                                                    cardUrl = data.data.getCardUrl
                                                }
                                                userInfo = data.data
                                            } else {
                                                isVip = true
                                                userInfo = data.data
                                            }
                                            sessionStorage.setItem('userInfo', JSON.stringify(data))

                                        }
                                    })
                                }
                            }) 
                        }
                        


                    }
                })
            }


            payType = 'WeChat_Pay'
            codeType = 'PublicAddress_Pay'
        }

    } else if (/AlipayClient/.test(window.navigator.userAgent)) {
        AlipayJSBridge.call('hideOptionMenu');
        if (window.location.href.indexOf('auth_code') == -1) {

            $.ajax({
                url: "https://api.51shanhe.com/p-server/appServer/getInfo",
                //url:"http://192.168.1.80:6017/p-server/appServer/getInfo",
                type: "POST",
                async: false,
                headers: {
                    "Content-Type": "application/json"
                },
                data: JSON.stringify(oData),
                success: function(data) {
                    if (data.code == 1000) {
                        console.timeEnd('aaa')
                        //alert(JSON.stringify(data))
                        // aliCode = JSON.parse(data.data.payBaseInfo).aliAppId;
                        // weixinCode = JSON.parse(data.data.payBaseInfo).wxAppId;
                        // merchantNumber = data.data.merchantNumber
                        merInfo = data.data
                        var ajData = new Object()
                        ajData.paymentType = 'Alipay_Pay'
                        ajData.merchantNumber = data.data.merchantNumber
                        ajData.equipmentNumber = clientNumber
                        ajData.shopNumber = data.data.storeId
                        ajData.clerkNumber = data.data.userNumber
                        ajData.codeType = 'ServiceWindow_Pay'
                        console.time('bbb')
                        //alert(JSON.stringify(ajData))
                        $.ajax({
                            //url: "http://api.51shanhe.com/p-server/appServer/getInfo",
                            url: "https://api.51shanhe.com/p-pay/pay/payRoute",
                            //url:"http://192.168.1.80:5008/p-pay/pay/payRoute",
                            type: "POST",
                            async: false,
                            headers: {
                                "Content-Type": "application/json"
                            },
                            data: JSON.stringify(ajData),
                            success: function(data) {
                                console.timeEnd('bbb')
                                //alert(JSON.stringify(data))
                                //aliCode = JSON.parse(data.data.payBaseInfo).aliAppId;
                                //weixinCode = JSON.parse(data.data.payBaseInfo).wxAppId;
                              if(data.code != 1000){
                                    alert(data.msg + 'payRoute')
                                    return
                                }else{
                                if (cardEnabled == 0) {
                                        var scope = "auth_user,auth_ecard,";
                                        
                                    }else{
                                        var scope = "auth_base";
                                    }
                                var redirect_uri = window.location.href;
                                    window.location.href = "https://openauth.alipay.com/oauth2/publicAppAuthorize.htm?app_id=" + data.data.appId + "&scope=" + scope + "&redirect_uri=" + redirect_uri
                                }
                                
                            }
                        })
                    } else {
                        alert(data.msg + 'getInfo')
                    }
                }
            })
            
        } else {
            code = window.location.href.split('auth_code=')[1];
            document.getElementById('loadstart').style.display = "none";
            payType = 'Alipay_Pay'
            codeType = 'ServiceWindow_Pay'
            isVip = false
        }
    }
    var num = 1 / window.devicePixelRatio;
    document.write('<meta name="viewport" content="width=device-width,initial-scale=' + num + ',minimum-scale=' + num + ',maximum-scale=' + num + ',user-scalable=no" />')
    //          alert(document.documentElement.clientWidth);
    var fz = document.documentElement.clientWidth / 10;
    document.getElementsByTagName("html")[0].style.fontSize = fz + "px";
    </script>
    <script src="./js/alipayjsapi.inc.min.js"></script>
    <script src="./js/jweixin-1.4.0.js"></script>
    <script src="./js/fastclick.js"></script>
    <script type="text/javascript">
    window.onload = function() {
        FastClick.attach(document.body)
    }
    </script>
    <style type="text/css">
    </style>
</head>

<body ontouchstart class="weui-wepay-pay-wrap">
    <div id="mask123" style="height:100%;width:100%;position:fixed;background-color:rgba(116,116,116,0);z-index:100000;display:none">
        <div style="position:absolute;left:30%;top:49%;width:40%;height:6%;line-height:1rem;text-align:center;background-color:rgba(116,116,116,.7);border-radius:10px;color:white;font-size:0.35rem">支付中,请稍后<span class="dotting"></span></div>
    </div>
    <div id="mask1234" style="height:100%;width:100%;position:fixed;background-color:rgba(116,116,116,0);z-index:100000;display:none">
        <div style="position:absolute;left:30%;top:49%;width:40%;height:6%;line-height:1rem;text-align:center;background-color:rgba(116,116,116,.7);border-radius:10px;color:white;font-size:0.35rem" id="mask12345"></div>
    </div>
    <div class="payVip" id="payVip" style="display:none">
        <div class="payVipBox">
            <div class="payVip-title">
                <div class="payVip-title-left">会员支付</div>
                <img src="img/close.png" class="payVip-title-right">
            </div>
            <div class="payVip-name  shopName-is"></div>
            <div class="payVip-money">￥460.00</div>
            <div class="payVip-sub" id="payVip-sub">确定支付</div>
        </div>
    </div>
    <div class="tianchong"></div>
    <div class="pay-top">
        <div class="shopBox1">
            <img src="img/shop-icon.png" class="shop-icon">
            <div class="shopName11 shopName-is"></div>
        </div>
        <!-- <div class="moneyBox1 vipTypeFalse" style="display:none">
            <div class="moneyBox1-top">订单金额</div>
            <div class="moneyBox1-two">
                <div class="moneyBox-two-icon">￥ </div>
                <div type="" name="" class="inputMoney1" id="paymoney">
                </div>
            </div>
        </div> -->
        <div class="moneyBox2 ">
            <div class="moneyBox2-left">订单金额</div>
            <div class="moneyBox2-right moneyBox2-right1">￥<span id="paymoney1"></span></div>
        </div>
        <div class="moneyBox2 vipIsPay" style="display:none">
            <!-- <div class="moneyBox2 " > -->
            <div class="moneyBox2-left" style="width:auto">支付金额(会员<span id="vipZhekou"></span>折)</div>
            <div class="moneyBox2-right">￥<span id="paymoney2">0.00</span></div>
            <div class="moneyBox2-right" style="color:red;font-size:0.3rem">(优惠<span id="youhui">0.00</span>元)</div>
        </div>
        <div class="wechatPay vipTypeTrue payC" data-id="0" style="display:none">
            <div class="wechatPay-left">
                <img class="wechatPay-left-img" src="img/wechat.png">
                <div class="wechatPay-left-text">微信支付</div>
            </div>
            <div class="wechatPay-right">
                <img src="img/checktrue.png" class="wechatPay-right-img choosePay">
            </div>
        </div>
        <div class="wechatPay vipTypeTrue payC" data-id="1" style="display:none" id="isVipUrl">
            <div class="wechatPay-left">
                <img class="wechatPay-left-img" src="img/vip.png">
                <div class="wechatPay-left-text">会员支付<span style="font-size:0.32rem"> (余额￥<span id="allMoney"></span>)</span></div>
            </div>
            <div class="wechatPay-mid" id="recharge">
                充值
            </div>
            <div class="wechatPay-right">
                <img src="img/checkfalse.png" class="wechatPay-right-img choosePay">
            </div>
        </div>
        <div class="noVipBox vipTypeFalse" style="display:none">
            <div class="noVipBox-left">激活会员卡</div>
            <div class="noVipBox-right" id="getCard"><span style="color:red;margin-right:3px">*</span>领取会员卡 > </div>
        </div>
        <div class="remark">
            <div class="remark-left">备注</div>
            <input type="text" class="remark-right" name="" placeholder="请输入备注信息" id="mark"  onblur="markBlue()" onfocus="markFocus()">
        </div>
    </div>
    <div class="payNumBox">
        <div class="payNum-item">
            <div class="paynum">1</div>
            <div class="paynum">4</div>
            <div class="paynum">7</div>
            <div class="paynum">.</div>
        </div>
        <div class="payNum-item">
            <div class="paynum">2</div>
            <div class="paynum">5</div>
            <div class="paynum">8</div>
            <div class="paynum">0</div>
        </div>
        <div class="payNum-item">
            <div class="paynum">3</div>
            <div class="paynum">6</div>
            <div class="paynum">9</div>
            <div class="paynum">00</div>
        </div>
        <div class="payNum-item payNum-item1">
            <div class="delete">
                <img src="img/delete.png" class="delete-img" id="pay-return">
            </div>
            <!--  <div class="clear">
                清空
            </div> -->
            <div class="paySub paySub-disable" id="payId">
                支付
            </div>
        </div>
    </div>
    <script type="text/javascript">
    $('#logo').css('left', document.body.offsetWidth / 2 - 25)
    var a, b, c
    var sInfo
    var codeTypeTrue = false
    var preNumber;
    $.getScript('https://pv.sohu.com/cityjson?ie=utf-8', function() {
        console.log(returnCitySN)
        ip = returnCitySN.cip
    });


    function getQueryString(name) {
        var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
        var r = decodeURIComponent(window.location.search).substr(1).match(reg);
        if (r != null) {
            return unescape(r[2]);
        }
        return null;
    }

    $('#payinfokey td').click(function(data) {
        console.log(this)
    })

    function ob() {
        $('#payinfokey').show()

    }
    function markBlue(){
        setTimeout(function(){
            $('.payNumBox').show()
        },200)
        
    }
    function markFocus(){
         setTimeout(function(){
            $('.payNumBox').hide()
        },200)
    }
    function of () {
        $('#payinfokey').hide()
    }

    function oc() {
        console.log('123')
    }
    $('#addMark').click(function() {
        $('#payinfokey').hide()
        var value = $('#mark').html().replace(',', '')
        console.log(value)
        layer.prompt({
            title: '请输入备注信息',
            formType: 3,
            value: value,
            yes: function(index, layero) {
                // 获取文本框输入的值
                var value = layero.find(".layui-layer-input").val();
                if (value) {

                    $('#mark').html(value)
                    $('#addMark').html('修改')
                    layer.close(index)
                    $('#payinfokey').show()
                } else {
                    $('#mark').html('')
                    $('#addMark').html('添加备注信息')
                    layer.close(index)
                    $('#payinfokey').show()
                }
            },
            btn2: function(pass, index) { //这里就是你要的
                console.log(pass, index)
                $('#payinfokey').show()
            },
        });

    })
    $(document).ready(function() {
        // var projectName = window.location.href.split('/oneCode')[0];
        var clientNumber = getQueryString('outTradeNo');
        var oData = new Object()
        oData.equipmentNumber = clientNumber
        
        //采用get方式调用服务
        var ggNum = payType == 'WeChat_Pay' ? 1 : 2

        $.ajax({
            url: "https://api.51shanhe.com/p-server/appServer/getInfo",
            //url:"http://192.168.1.80:6017/p-server/appServer/getInfo",
            type: "POST",
            async: false,
            headers: {
                "Content-Type": "application/json"
            },
            data: JSON.stringify(oData),
            success: function(data) {

                if (data.code != 1000) {

                    alert(data.msg)
                    return
                }
                //alert(JSON.stringify(data))
                $("#shopName").html(data.data.storeName);
                sInfo = data.data
                merchantNumber = data.data.merchantNumber
                merInfo = data.data
                if(merInfo.storeName.length >16){
                    $('.shopName-is').text(merInfo.storeName.substr(0,16) + '..')
                }else{
                  $('.shopName-is').text(merInfo.storeName)
                }

                merNumber = data.data.merchantNumber
                insNumber = data.data.insNumber
                a = data.data.appPushClerkKey
                b = data.data.appPushMechantKey
                c = data.data.pcPushKey
                sInfo.clientNumber = clientNumber
                sessionStorage.setItem('sInfo', JSON.stringify(sInfo))
                
            }
        });
    })

    $(function() {
        if (isVip == true) {
            $('.vipTypeTrue').show()
            console.log(userInfo.allBalance)
            $('#allMoney').html(userInfo.allBalance)
            $('#vipZhekou').html(parseFloat(userInfo.disCountRate) * 10)

        } else {
            if(getQueryString('cardEnabled') == 0){
                console.log(userInfo)
                if(payType == 'WeChat_Pay' && userInfo.getCardUrl != ''){
                    $('.vipTypeFalse').show()
                }
            }
            
            
        }

        $('#getCard').click(function() {
            console.log(cardUrl)
            window.location.href = cardUrl
        })

        $('.payC').click(function() {
            console.dir(this)
            if (this.dataset.id == 0) {
                console.log(0)
                $('.choosePay').eq(1).attr('src', 'img/checkfalse.png')
                $('.choosePay').eq(0).attr('src', 'img/checktrue.png')
                payChoose = 0
                console.log(userInfo.disCountRate)
                if (userInfo.disCountRate != null && userInfo.holidayState == 0 && parseFloat($('#paymoney1').text()) >= parseFloat(userInfo.minConsumMoney)) {
                    $('.vipIsPay').hide()
                } else {
                    $('.vipIsPay').hide()
                }
                console.log(userInfo.holidayState)
            } else {

                $('.choosePay').eq(1).attr('src', 'img/checktrue.png')
                $('.choosePay').eq(0).attr('src', 'img/checkfalse.png')
                payChoose = 1
                if (userInfo.disCountRate == null || userInfo.holidayState != 0 || parseFloat($paymoney1.text()) < parseFloat(userInfo.minConsumMoney) ) {
                    time123 = setTimeout(function() {
                        $('#paymoney2').text($paymoney1.text())
                        $('#youhui').text(0)
                    })
                } else {
                    time123 = setTimeout(function() {
                        $('#paymoney2').text(($paymoney1.text() * userInfo.disCountRate).toFixed(2))
                        $('#youhui').text(((Math.round($paymoney1.text() * (1 - userInfo.disCountRate) * 100)) / 100).toFixed(2))
                    })
                }
                if (userInfo.disCountRate != null && userInfo.holidayState == 0 && parseFloat($('#paymoney1').text()) >= parseFloat(userInfo.minConsumMoney)) {
                    $('.vipIsPay').show()
                } else {

                    $('.vipIsPay').hide()
                }
            }
        })

        function onBridgeReady(appId, time, nonceStr, package, signType, paySign, ggdata) {

            WeixinJSBridge.invoke(
                'getBrandWCPayRequest', {
                    "appId": appId,
                    "timeStamp": time,
                    "nonceStr": nonceStr,
                    "package": package,
                    "signType": signType,
                    "paySign": paySign
                },
                function(res) {


                    if (res.err_msg == "get_brand_wcpay_request:ok") {
                        window.location.href = "https://api.51shanhe.com/h5-pay/lh-ad.html?insNumber=" + insNumber;
                    } else {
                        //alert("支付失败")

                        var wlh = window.location.href.split('&code=')[0]
                        if(getQueryString('cardEnabled') == 1){
                            window.location.href = wlh
                        }
                        // if (/MicroMessenger/.test(window.navigator.userAgent)) {
                        //     var scope = "auth_base";
                        //     var redirect_uri = wlh;
                        //     window.location.href = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=" + weixinCode + "&redirect_uri=" + encodeURIComponent(redirect_uri) + "&response_type=code&scope=snsapi_base&state=start#wechat_redirect"
                        // } else if (/AlipayClient/.test(window.navigator.userAgent)) {
                        //     if (window.location.href.indexOf('auth_code') == -1) {

                        //         var scope = "auth_base";
                        //         var redirect_uri = wlh;
                        //         window.location.href = "https://openauth.alipay.com/oauth2/publicAppAuthorize.htm?app_id=" + aliCode + "&scope=" + scope + "&redirect_uri=" + redirect_uri
                        //     } else {
                        //         code = window.location.href.split('auth_code=')[1];
                        //         document.getElementById('loadstart').style.display = "none";
                        //         payType = 'Alipay_Pay'
                        //         codeType = 'ServiceWindow_Pay'
                        //     }
                        // }
                    }
                }
            );
        }
        var clientNumber = getQueryString('outTradeNo');
        var isC = true;

        $('#recharge').click(function() {
            window.location.href = 'recharge.html?money=' + userInfo.allBalance
        })
        $('#payVip-sub').click(function() {
            var $paymoney1 = $('#paymoney1');
            console.log($paymoney1.text())
            $('#mask123').show()
            var bData = new Object()
            bData.memberNo = userInfo.memberNo
            bData.consumMoney = $('#paymoney1').text()
            bData.shopNumber = ''
            bData.clerkNumber = ''
            bData.merchantNumber = merchantNumber
            bData.institutionNumber = '1003'
            bData.remarks = $('#mark').val()
            bData.consumptionType = '3'
            bData.useIntegral = '0'
            bData.deductionIntegral = ''
            bData.longitude = ''
            bData.latitude = ''
            bData.ip = ''
            bData.payType = '0'
            console.log(bData)

            $.ajax({
                url: "https://api.51shanhe.com/p-member/consumption/consum",
                //url:"http://192.168.1.80:6017/p-server/appServer/getInfo",
                type: "POST",
                async: true,
                headers: {
                    "Content-Type": "application/json"
                },
                data: JSON.stringify(bData),
                success: function(data) {
                    console.log(JSON.stringify(data))

                    if (data.code == 1000) {
                        var sData = data
                        sData.data.merchantName = merInfo.userName
                        sData.data.insNumber = merInfo.insNumber
                        setTimeout(function() {
                            $('#mask123').hide()
                        }, 5000)
                        window.location.href = 'orderDetail.html?orderInfo=' + JSON.stringify(sData) + '&insNumber='+insNumber
                    } else {
                        $('#mask123').hide()
                        $('#mask12345').html(data.msg)
                        $('#mask1234').show()
                        setTimeout(function() {
                            $('#mask1234').hide()
                        }, 2000)
                    }

                }
            })
            return
        })
        $('.payVip-title-right').click(function() {
            $('#payVip').hide()
        })
        $('#payId').click(function() {
            if (isVip == true && payChoose == 1) {
                var moneyNumber = $('#paymoney2').text()
                if(parseFloat(moneyNumber) > parseFloat(userInfo.allBalance)){
                    $('#mask12345').html('金额不足,请充值')
                        $('#mask1234').show()
                        setTimeout(function() {
                            $('#mask1234').hide()
                        }, 2000)
                    return
                }
                $('.payVip-money').text('￥' + parseFloat(moneyNumber).toFixed(2))
                $('#payVip').show()
                return
            }
            if (isC != true) {
                return
            }
            isC = false;
            var totalFee = parseFloat(document.getElementById("paymoney1").innerHTML);
            if ($paymoney1.text() == '') {
                alert("请输入金额！");

            } else if ($paymoney1.text() < 0.1) {
                alert("请输入正确的金额，最低为0.1元");
            } else {
                $('#mask123').show()
                var url = document.getElementById("payUrl");
                // if (url.value == '' || url.value == null || url.value == undefined) {
                //     alert("二维码未绑定成功,无法支付！");
                // } else {
                // document.getElementById('payId').style.display = "none";
                //document.getElementById('loading-zf').style.display = "block";
                var ssInfo = JSON.parse(sessionStorage.getItem('sInfo'))
                var ajData = new Object()
                ajData.paymentType = payType
                ajData.merchantNumber = ssInfo.merchantNumber
                ajData.equipmentNumber = clientNumber
                ajData.shopNumber = ssInfo.storeId
                ajData.clerkNumber = ssInfo.userNumber
                if(payType == 'WeChat_Pay'){
                    if(getQueryString('cardEnabled') == 1){
                        ajData.code = code
                    }else{
                          ajData.openId = userInfo.subOpenId
                         //if (userInfo.subAppId == null) {
                           // console.log('123')

                            //ajData.openId = userInfo.subOpenId
                        //} else {
                          //  console.log('456')
                           // ajData.openId = userInfo.openid
                        //}
                   

                    }
                }else{
                    ajData.code = code
                }
                ajData.codeType = codeType
                ajData.appPushClerkKey = a
                ajData.appPushMechantKey = b
                ajData.pcPushKey = c
                 ajData.orderRemark = $('#mark').val()
                $.ajax({
                    //url: "http://api.51shanhe.com/p-server/appServer/getInfo",
                    url: "https://api.51shanhe.com/p-pay/pay/payRoute",
                    //url:"http://192.168.1.80:5008/p-pay/pay/payRoute",
                    type: "POST",
                    async: false,
                    headers: {
                        "Content-Type": "application/json"
                    },
                    data: JSON.stringify(ajData),
                    success: function(data) {
                        if(data.code != 1000){
                            alert(data.msg + 'payRoute')
                            return
                        }
                        preNumber = data.data.preNumber
                        // alert(preNumber)
                        var aad = new Object()
                aad.totalMoney = totalFee
                // aad.paymentType = payType,
                // aad.merchantNumber = merNumber,
                // aad.code = code,
                //     aad.codeType = codeType,
                //     aad.orderRemark = $('#mark').val()
                // aad.shopNumber = sInfo.storeId,
                //     aad.clerkNumber = sInfo.userNumber
                // aad.appPushClerkKey = a
                // aad.appPushMechantKey = b
                // aad.pcPushKey = c
                // aad.equipmentType = 3
                // aad.equipmentNumber = clientNumber
                // aad.ip = ip
                console.log(userInfo)
                if(payType == 'WeChat_Pay'){
                    console.log(getQueryString('cardEnabled'))
                    if(getQueryString('cardEnabled') == 1){
                        aad.code = code
                    }else{
                        aad.openId = userInfo.subOpenId
                        //if (userInfo.subAppId == null) {
                          //  console.log('123')

                            //aad.openId = userInfo.subOpenId
                        //} else {
                          //  console.log('456')
                           // aad.openId = userInfo.openid

                        //} 
                    }
                   
                }else{
                    aad.code = code
                }
                

                aad.preNumber = preNumber
                //alert( JSON.stringify(aad),)
                $.ajax({
                    url: "https://api.51shanhe.com/p-pay/pay/qrCode",
                    //url:"http://192.168.1.80:5008/p-pay/pay/qrCode",
                    //url: "http://192.168.1.80:5008/p-pay/pay/payRoute",
                    type: "POST",
                    async: true,
                    headers: {
                        "Content-Type": "application/json"
                    },
                    data: JSON.stringify(aad),

                    success: function(data) {
                        $('#mask123').hide()
                        codeTypeTrue = true
                        setTimeout(function() {
                            isC = true
                        }, 500)
                        //alert(JSON.stringify(data))
                        //var ggdata = data.guanggao、
                        if (data.code != 1000) {
                            alert(data.msg +'qrCode')
                            // document.getElementById('payId').style.display = "block";
                            // document.getElementById('loading-zf').style.display = "none";
                            document.getElementById('paymoney').innerHTML = "";
                        }
                        if (data.data.client == 'ALIPAY') {
                            ap.tradePay({
                                tradeNO: data.data.tradeNO
                            }, function(res) {
                                document.getElementById('payId').style.display = "block";


                                if (res.resultCode == 9000) {
                                    window.location.href = "https://api.51shanhe.com/h5-pay/lh-ad.html?insNumber=" + insNumber;
                                } else {
                                    //alert('支付失败')
                                    // var wlh = window.location.href.split('&code=')[0]
                                    // if (/MicroMessenger/.test(window.navigator.userAgent)) {
                                    //     var scope = "auth_base";
                                    //     var redirect_uri = wlh;
                                    //     window.location.href = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=" + weixinCode + "&redirect_uri=" + encodeURIComponent(redirect_uri) + "&response_type=code&scope=snsapi_base&state=start#wechat_redirect"
                                    // } else if (/AlipayClient/.test(window.navigator.userAgent)) {
                                    //     var scope = "auth_base";
                                    //     var redirect_uri = wlh;
                                    //     window.location.href = "https://openauth.alipay.com/oauth2/publicAppAuthorize.htm?app_id=" + aliCode + "&scope=" + scope + "&redirect_uri=" + redirect_uri

                                    // }

                                }
                            });
                        } else {
                            onBridgeReady(data.data.map.appId, data.data.map.timeStamp, data.data.map.nonceStr, data.data.map.package, data.data.map.signType, data.data.map.paySign);
                        }
                    },
                    fail: function(e) {

                    },
                    error: function(e) {
                        console.log(e)
                    }
                })
                    }
                })
                

            }
        });
        $(".payinfo").slideDown();
        var $paymoney = $("#paymoney");
        var $paymoney1 = $('#paymoney1')
        var time123
        $(".paynum").each(function() {
            $(this).click(function() {
                console.log($(this).text())

                isC = true
                if ($(this).text() == '.' && $paymoney1.text().indexOf('.')>=0) {
                   return
                }
                if (($paymoney1.text()).indexOf(".") != -1 && ($paymoney1.text()).substring(($paymoney1.text()).indexOf(".") + 1, ($paymoney1.text()).length).length == 2) {
                    return;
                }

                if (parseInt($paymoney1.text()) >= 99999 && $paymoney1.text().indexOf(".") == -1) {
                    return;
                }
                $('.paySub').removeClass('paySub-disable');
                 if ($(this).text() == '.' && $paymoney1.text() == '') {
                    $paymoney1.text('0.')
                }else{
                   $paymoney.text($paymoney.text() + $(this).text());
                $paymoney1.text($paymoney1.text() + $(this).text()); 
                }
                
               
                if (isVip == true) {
                    clearTimeout(time123)
                    console.log($paymoney1.text() , userInfo.minConsumMoney)
                    console.log(parseFloat($paymoney1.text()) < parseFloat(userInfo.minConsumMoney))
                    if (userInfo.disCountRate == null || userInfo.holidayState != 0 || parseFloat($paymoney1.text()) < parseFloat(userInfo.minConsumMoney) ) {
                        time123 = setTimeout(function() {
                            $('#paymoney2').text($paymoney1.text())
                            $('#youhui').text(0)
                        })
                    } else {
                        time123 = setTimeout(function() {
                            $('#paymoney2').text(($paymoney1.text() * userInfo.disCountRate).toFixed(2))
                            $('#youhui').text(((Math.round($paymoney1.text() * (1 - userInfo.disCountRate) * 100)) / 100).toFixed(2))
                        })
                    }

                    if (payChoose == 1 && userInfo.disCountRate != null && userInfo.holidayState == 0 && parseFloat($('#paymoney1').text()) >= parseFloat(userInfo.minConsumMoney)) {
                        $('.vipIsPay').show()
                    } else {

                        $('.vipIsPay').hide()
                    }
                }


            });
        });

        $("#pay-return").click(function() {
            $paymoney.text(($paymoney.text()).substring(0, ($paymoney.text()).length - 1));
           
            $paymoney1.text(($paymoney1.text()).substring(0, ($paymoney1.text()).length - 1));
            if (!$paymoney1.text()) {
                $('.paySub').addClass('paySub-disable')
            }
            if (isVip == true) {
                
                if (payChoose == 1 && userInfo.disCountRate != null && userInfo.holidayState == 0 && parseFloat($('#paymoney1').text()) >= parseFloat(userInfo.minConsumMoney)) {
                    $('.vipIsPay').show()
                    clearTimeout(time123)
                    time123 = setTimeout(function() {
                        $('#paymoney2').text(($paymoney1.text() * userInfo.disCountRate).toFixed(2))
                        $('#youhui').text(((Math.round($paymoney1.text() * (1 - userInfo.disCountRate) * 100)) / 100).toFixed(2))
                    })
                } else {
                    $('#paymoney2').text($paymoney1.text())
                        $('#youhui').text(0)
                    $('.vipIsPay').hide()
                }
            }
        });

        $("#pay-zero").click(function() {
            if (($paymoney.text()).indexOf(".") != -1 && ($paymoney.text()).substring(($paymoney.text()).indexOf(".") + 1, ($paymoney.text()).length).length == 2) {
                return;
            }
            if ($.trim($paymoney.text()) == "0") {
                return;
            }
            if (parseInt($paymoney.text()) > 10000 && $paymoney.text().indexOf(".") == -1) {
                return;
            }
            $paymoney.text($paymoney.text() + $(this).text());
        });

        $("#pay-float").click(function() {
            if ($.trim($paymoney.text()) == "") {
                return;
            }
            if (($paymoney.text()).indexOf(".") != -1) {
                return;
            }
            if (($paymoney.text()).indexOf(".") != -1) {
                return;
            }
            $paymoney.text($paymoney.text() + $(this).text());
        });
        if (!$paymoney.text()) {
            $('.paySub').addClass('paySub-disable');
        }
        if (!!payNumber) {
            $('#payinfokey').hide()
        }
    });
    $(function() {
        pushHistory();

        window.addEventListener("popstate", function(e) {
            if (/MicroMessenger/.test(window.navigator.userAgent)) {
                // 微信
                WeixinJSBridge.call('closeWindow');
            } else if (/AlipayClient/.test(window.navigator.userAgent)) {
                // 支付宝
                AlipayJSBridge.call('popWindow');
            }
        }, false);
        document.querySelector('body').addEventListener('touchmove', function(e) {
            e.preventDefault();
        })



        function pushHistory() {
            var state = {
                title: "title",
                url: "#"
            };
            window.history.pushState(state, "title", "#");
        }

    })
 
    </script>
</body>

</html>