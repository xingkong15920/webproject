<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
		<link rel="stylesheet" href="../../public/css/font.css">
		<link rel="stylesheet" href="../../public/css/xadmin.css">
		<link rel="stylesheet" href="../../public/css/vipS.css">
		<script type="text/javascript" src="../../public/js/jquery-3.2.1.js"></script>
		<script type="text/javascript" src="../../public/js/jquery-1.8.3.min.js"></script>
		<script type="text/javascript" src="../../public/js/vue.min.js"></script>
		<script type="text/javascript" src="../../public/lib/layui/layui.js" charset="utf-8"></script>
		<script type="text/javascript" src="../../public/js/xadmin.js"></script>
		<script type="text/javascript" src="../../public/js/qrcode.js"></script>
		<!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
		<!--[if lt IE 9]>
            <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
            <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
		<style type="text/css">
			.set {
				width: 110px;
				margin-right: 10px;
			}

			.layui-upload-img {
				width: 150px;
				height: 150px;
				border: 1px solid #e6e6e6;
				border-radius: 2px;
				display: flex;
				justify-content: center;
				align-items: center;
			}

			#demoText {
				width: 150px;
				height: auto;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			#demoText span {
				margin-top: 10px;
			}

			#demoText a {
				margin-top: 10px;
			}

			.layui-tab-title li:first-child {
				width: 100px;
			}

			.layui-tab-title li {
				width: 100px;
			}

			.del {
				/* position: absolute;
				right: 0;
				top: 0; */
				width: 30px;
				height: 28px;
				line-height: 26px;
				margin-right: 10px;
				top: 1px;
				text-align: center;
				color: #c2c2c2;
				font-size: 20px;
				text-align: center;
				vertical-align: middle;
				display: inline-block;
				border: 1px solid #d2d2d2;
				margin-top: 3px;
				margin-left: -5px;
				text-indent: 2px;
				cursor: pointer;
			}

			.del:hover {
				background-color: #ff5722;
			}

			.layui-form-checkbox {
				margin-right: 0;
			}

			.layui-elem-quote {
				font-size: 18px;
			}

			.layui-elem-quote .layui-form-switch {
				width: 40px;
				margin: 0 15px;
				margin-top: 0;
			}

			.tips_red {
				color: red;
			}

			.tagsBody {
				max-width: 800px;
				border: 1px solid #e6e6e6;
				padding: 10px;
			}

			.tagsBody .layui-form-item:last-child {
				margin: 0;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.site-demo-active {
				width: 100px;
			}

			.newTagsInput {
				width: calc(100% - 100px);
				margin-right: 10px;
			}

			#timing .layui-form-label {
				width: auto;
			}

			.invisible {
				background: url('../../public/images/icon-invisible.png') no-repeat;
				top: 10px;
				height: 19px;
			}

			.visible {
				background: url('../../public/images/icon-visible.png') no-repeat;
				top: 5px;
				height: 28px;
			}

			.conBlock {
				padding: 20px;
			}

			.authCon {
				padding: 0 15px;
			}

			.authCon.authFlex {
				display: flex;
				justify-content: space-between;
				align-items: center;
				flex-wrap: wrap;
				margin-bottom: 20px;
			}

			.authConL {
				width: 50%;
				display: flex;
				justify-content: flex-start;
				align-items: center;
			}

			.authConLImg {
				width: 80px;
				height: 80px;
				border-radius: 5px;
				border: 1px solid #ddd;
				margin-right: 20px;
			}

			.authConLB {
				display: flex;
				justify-content: center;
				align-items: flex-start;
				flex-direction: column;
				color: #666;
			}

			.authConLB h3 {
				font-size: 16px;
				color: #000;
				margin-bottom: 5px;
			}

			.authConLB p:nth-child(2) {
				margin-bottom: 5px;
			}

			.authConR {
				width: 50%;
				display: flex;
				align-items: flex-end;
				justify-content: center;
				flex-direction: column;
				color: #999;
			}

			.authConR div {
				margin-bottom: 10px;
			}

			.authCon.matilsFu {
				display: flex;
				align-items: center;
				justify-content: flex-start;
				flex-wrap: wrap;
			}

			.auth_matilsFu {
				width: 50%;
				line-height: 2;
				color: #999;
			}

			.authConUl {
				width: 100%;
				display: flex;
				justify-content: flex-start;
				align-items: center;
				flex-wrap: wrap;
				margin-top: 20px;
			}

			.authConUl li {
				width: 140px;
				line-height: 2;
				position: relative;
				padding-left: 15px;
				margin-right: 15px;
				font-size: 12px;
				color: #999;
			}

			.authConUl li:before {
				content: '';
				position: absolute;
				top: 8px;
				left: 0px;
				width: 6px;
				height: 6px;
				overflow: hidden;
				border-radius: 50%;
				background: #999;
			}

			.ewmBtn {
				display: inline-block;
				color: #008000;
			}

			.ewmBtn:hover {
				color: #008000;
			}

			.auth_matilsFu span {
				width: 80px;
				text-align: right;
				display: inline-block;
			}

			.auth_conditions li {
				padding-left: 25px;
				position: relative;
				line-height: 2;
				color: red;
			}

			.auth_conditions li .auth_tips {
				font-size: 10px;
				color: #999;
			}

			.auth_conditions li:before {
				content: '';
				position: absolute;
				top: 10px;
				left: 8px;
				width: 6px;
				height: 6px;
				overflow: hidden;
				border-radius: 50%;
				background: red;
			}
		</style>
	</head>

	<body class="iframe_index_1 autoHeight">
		<div class="conBlock">
			<div id="authDetails" v-cloak>
				<blockquote class="layui-elem-quote consumeTit">
					<i class="leftline"></i>
					授权信息
				</blockquote>
				<div class="authCon authFlex">
					<div class="authConL">
						<img :src="authCon.headImg" class="authConLImg">
						<div class="authConLB">
							<h3>{{authCon.nickName}}</h3>
							<p>{{authCon.serviceTypeC}} | {{authCon.verifyTypeC}}</p>
							<p>已授权</p>
						</div>
					</div>
					<div class="authConR">
						<div class="layui-btn layui-btn-lg" @click="updateAuth()">更新授权</div>
						<p>公众号功能有所升级，可更新授权</p>
					</div>
					<ul class="authConUl">
						<li v-for="item in authCon.funcInfostr">
							{{item}}
						</li>
					</ul>
				</div>

				<blockquote class="layui-elem-quote consumeTit">
					<i class="leftline"></i>
					公众号信息
				</blockquote>
				<div class="authCon matilsFu">
					<p class="auth_matilsFu"><span>微信号：</span>{{authCon.wechatNo}}</p>
					<p class="auth_matilsFu"><span>二维码：</span><a class="ewmBtn" v-on:click="ewm(authCon.qrcode)">查看</a></p>
					<p class="auth_matilsFu"><span>原始ID：</span>{{authCon.userName}}</p>
					<p class="auth_matilsFu"><span>APPID：</span>{{authCon.authorizationAppId}}</p>
					<p class="auth_matilsFu"><span>公司主体：</span>{{authCon.subject}}</p>
					<p class="auth_matilsFu"><span>授权时间：</span>{{authCon.authorizationTime}}</p>
					<p class="auth_matilsFu" style="width: 100%;"><span>介绍信息：</span>{{authCon.introduce}}</p>
					<p style="margin-top: 20px;">若您不希望使用本平台管理公众账号，请到微信公众平台->添加功能插件->授权管理中取消授权</p>
				</div>
			</div>
		</div>
		<div class="conBlock" id="shouquan" style="display:none">
			<blockquote class="layui-elem-quote consumeTit">
				<i class="leftline"></i>
				授权条件
			</blockquote>
			<ul class="auth_conditions">
				<li>
					已通过微信认证的服务号。
				</li>
				<li>
					已开通卡券功能。 <br />
				</li>
				<li>
					已开通模板消息。<br />
					<span class="auth_tips">为保证会员卡信息变更通知的发送，模板消息所在行业中，必须有一个要选择「IT科技 互联网|电子商务」。</span><br />
					<span class="auth_tips">模板消息功能和卡券功能，可进入微信公众平台 -> 添加功能插件，选择卡券功能或模板消息功能，申请开通。</span><br />
				</li>
				<li>
					如需使用小程序功能，在进行公众号授权时，请务必确认已勾选【开放平台账号管理权限】，再进行授权。<br />
					<span class="auth_tips">公众号只可将此权限授权给一个第三方平台，如已绑定其它第三方平台，请到微信公众平台 -> 添加功能插件 -> 授权管理，手动解绑其它第三方，再进行授权。</span>
				</li>
			</ul>
		</div>
		<div class="conBlock" id="daizhi" style="display:none">
			<blockquote class="layui-elem-quote consumeTit">
				<i class="leftline"></i>
				会员卡模式
			</blockquote>
			<ul class="auth_conditions">
				<li>
					已选择使用代制模式
				</li>
			</ul>
		</div>
		<div class="cardQrcode" style="display: none;">
			<div id="qrcode" style="width:340px; height:340px;margin: 20px;"></div>
		</div>
		<script src="../../common/config-sh.js"></script>
		<script src="../../common/utility.js"></script>
		<script src="../../public/js/qrcode.js"></script>
		<script>
			$(".conBlock:last").css("margin-bottom", "0");
			var serverUrl = 'http://192.168.110.190:5002/'
			// var userNumber = JSON.parse(sessionStorage.getItem('organUser')).institutionNumber;
			var code1;
			var jgData;
			var merchantca = false;
			var type;
			var logoUrl = '';
			var shHref 
			CmsUtility.postAjaxCall2(
								//系统设置
				 'https://nb.51shanhe.com/shanhe-admin/basicSetting/getInsRegInfo', {
                    'institutionNumber': insNumber,
                },
				function(data){
					if(data.code == 1000){
						shHref = isHttps(data.data[0].interfaceAddress )
						
					}else{
						layer.msg(data.msg)
						
					}
				},
				function(data){
					console.log('222')
				}
			)
			function switchPwd() {
				var passwordeye = $('#passwordeye');
				var showPwd = $("#miyao");
				passwordeye.off('click').on('click', function() {
					if (passwordeye.hasClass('invisible')) {
						passwordeye.removeClass('invisible').addClass('visible'); //密码可见
						showPwd.prop('type', 'text');
					} else {
						passwordeye.removeClass('visible').addClass('invisible'); //密码不可见
						showPwd.prop('type', 'password');
					};
				});
			}
			switchPwd()
			layui.use(['laydate', 'table', 'form', 'laytpl', 'upload'], function() {
				layui.$.support.cors = true; //允许ajax跨域
				var $ = layui.jquery,
					upload = layui.upload,
					laydate = layui.laydate,
					table = layui.table,
					form = layui.form,
					laytpl = layui.laytpl;
				layer.load(2, {
					shade: 0.5
				});

				$.ajax({
					type: 'get',
					url: CmsConfig.ServiceUrl.ApiRootUrlMeb + CmsConfig.addressUrl.Mervip.getAuthorizetInfo,
					data: {
						'authType': 1,
						'merchantNumber': JSON.parse(sessionStorage.getItem('userSh')).Number,
					},
					dataType: 'json',
					success: function(data) {
						layer.closeAll('loading');
						if (data.code == 1000) {
							$('#auth').show()
							$('#shouquan').show()
							if (data.data.openCard == 0) {
								layer.msg('您当前微信未开通卡券功能')
							}
							setDetail(data.data)
						} else if (data.code == '-2') {
							window.location.href = 'unauth.html?authTypt=WeChat'
						} else if (data.code == '500') {

							$('#daizhi').show()
						}
					}
				});


				//表单初始赋值
				form.val('basic', {
					"insNumber": JSON.parse(sessionStorage.getItem('userSh')).institutionNumber,
					"merchantNumber": JSON.parse(sessionStorage.getItem('userSh')).Number
				})

				$('.layui-btn.layui-btn-lg').click(function() {
					console.log(1111)
				})

				function setDetail(obj) {
					layer.closeAll('loading');
					new Vue({
						el: '#authDetails',
						data: {
							authCon: changeData(obj)
						},
						methods: {
							ewm: function(url) {
								qrcode.makeCode(url);
								layer.open({
									type: 1,
									shadeClose: true,
									shade: 0.5,
									title: false,
									area: ['380px', '380px'],
									content: $('.cardQrcode'),
								});
							},
							updateAuth: function() {

								// layer.open({
								// 	type: 2,
								// 	title: false,
								// 	area: ['100%', '100%'],
								// 	closeBtn: 0,
								// 	content: 'authSuccess.html',
								// 	success: function(layero, index) {}
								// });

								layer.confirm('更改授权公众号会导致现有的卡券不可用，确认更新授权吗？', {
									btn: ['确定', '取消'] //按钮
								}, function() {
									layer.open({
										type: 2,
										title: '微信授权',
										area: ['90%', '90%'],
										content: shHref + '/wechatAuth/authBack.html?merchantNumber=' + JSON.parse(
											sessionStorage
											.getItem('userSh')).Number + '&authType=1&operationType=1',
										success: function(layero, index) {
											// 获取子页面的iframe
											var iframe = window['layui-layer-iframe' + index];
											// 向子页面的全局函数child传参
											// iframe.subPageadvert(data, userNumber)
										}
									});
								}, function() {
									layer.closeAll()
								});
							}
						}
					})
				}

				function changeData(obj) {
					switch (obj.serviceType) {
						case 0:
							obj.serviceTypeC = '订阅号'
							break;
						case 1:
							obj.serviceTypeC = '升级后订阅号'
							break;
						case 2:
							obj.serviceTypeC = '服务号'
							break;
					}
					switch (obj.verifyType) {
						case -1:
							obj.verifyTypeC = '未认证'
							break;
						case 0:
							obj.verifyTypeC = '微信认证'
							break;
						case 1:
							obj.verifyTypeC = '新浪微博认证'
							break;
						case 2:
							obj.verifyTypeC = '腾讯微博认证'
							break;
						case 3:
							obj.verifyTypeC = '资质已认证,未名称认证'
							break;
						case 4:
							obj.verifyTypeC = '资质已认证、未名称认证，已新浪微博认证'
							break;
						case 5:
							obj.verifyTypeC = '资质已认证、未名称认证，已腾讯微博认证'
							break;
					}
					var funcInfoC = obj.funcInfo.split(',')
					var funcInfostr = []
					for (i = 0; i < funcInfoC.length; i++) {
						switch (parseFloat(funcInfoC[i])) {
							case 1:
								funcInfostr.push('消息管理权限')
								break;
							case 2:
								funcInfostr.push('用户管理权限')
								break;
							case 3:
								funcInfostr.push('帐号服务权限')
								break;
							case 4:
								funcInfostr.push('网页服务权限')
								break;
							case 5:
								funcInfostr.push('微信小店权限')
								break;
							case 6:
								funcInfostr.push('微信多客服权限')
								break;
							case 7:
								funcInfostr.push('群发与通知权限')
								break;
							case 8:
								funcInfostr.push('微信卡券权限')
								break;
							case 9:
								funcInfostr.push('微信扫一扫权限')
								break;
							case 10:
								funcInfostr.push('微信连WIFI权限')
								break;
							case 11:
								funcInfostr.push('素材管理权限')
								break;
							case 12:
								funcInfostr.push('微信摇周边权限')
								break;
							case 13:
								funcInfostr.push('微信门店权限')
								break;
							case 15:
								funcInfostr.push('自定义菜单权限')
								break;
							case 16:
								funcInfostr.push('获取认证状态及信息')
								break;
							case 17:
								funcInfostr.push('帐号管理权限(小程序)')
								break;
							case 18:
								funcInfostr.push('开发管理与数据分析权限(小程序)')
								break;
							case 19:
								funcInfostr.push('客服消息管理权限(小程序)')
								break;
							case 20:
								funcInfostr.push('微信登录权限(小程序)')
								break;
							case 21:
								funcInfostr.push('数据分析权限(小程序)')
								break;
							case 22:
								funcInfostr.push('城市服务接口权限')
								break;
							case 23:
								funcInfostr.push('广告管理权限')
								break;
							case 24:
								funcInfostr.push('开放平台帐号管理权限')
								break;
							case 25:
								funcInfostr.push('开放平台帐号管理权限(小程序)')
								break;
							case 26:
								funcInfostr.push('微信电子发票权限')
								break;
							case 41:
								funcInfostr.push('搜索widget的权')
								break;
						}
					}
					obj.funcInfostr = funcInfostr
					console.log(obj)
					return obj
				}
			})
			var qrcode = new QRCode(document.getElementById("qrcode"), {
				width: 340,
				height: 340
			});
		</script>
	</body>

</html>
