<!DOCTYPE html>
<html>

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title></title>
		<meta name="renderer" content="webkit|ie-comp|ie-stand">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=1, user-scalable=0">
		<meta http-equiv="Cache-Control" content="no-siteapp" />
		<link rel="stylesheet" href="../../public/css/xadmin.css">
		<link rel="stylesheet" href="../../public/css/style.1.2.1.css">
		<link rel="stylesheet" href="../../public/css/vipS.css">
		<script type="text/javascript" src="../../public/js/jquery-3.2.1.js"></script>
		<script type="text/javascript" src="../../public/js/vue.min.js"></script>
		<script type="text/javascript" src="../../public/lib/layui/layui.js" charset="utf-8"></script>
		<script type="text/javascript" src="../../public/js/xadmin.js"></script>
		<script type="text/javascript" src="../../public/js/data.js"></script>
		<style type="text/css">
			.hide {
				display: none;
			}

			.show {
				display: block;
			}

			.layui-table-cell {
				height: auto;
			}

			.vipdetail {
				height: 100%;
				background: #f4f8fb;
			}

			.vipdetail .vipdetail_B {
				height: auto;
				display: flex;
				justify-content: space-between;
				align-items: flex-start;
				flex-wrap: wrap;
			}

			.vipdetail_B_D {
				width: 100%;
				overflow: hidden;
			}

			.layui-table-view {
				width: 100%;
			}

			.widthHalf .consumeTit {
				justify-content: space-between;
			}

			.subAcFullright {
				margin-left: auto;
			}

			.widthHalf {
				margin: 0;
			}
			.layui-block{
				height: 40px;
				margin-bottom: 10px;
			}
		</style>
	</head>

	<body>
		<div class="x-body vipdetail layui-form" style="padding: 0;" lay-filter="cardAdd">
			<div class="vipdetail_B " id="mDetails" >
				<div class="conBlock widthAll">
					<blockquote class="layui-elem-quote consumeTit">
						<i class="leftline"></i>
						分账基础设置
					</blockquote>
					<div class="vipdetail_B_D">
						<div class="layui-form-item">
							<div class="layui-block">
								<label class="layui-form-label">微信分账比例</label>
								<div class="layui-input-inline">
									<input type="text" name="separateAccountsBill" lay-verify="required|number" autocomplete="off" class="layui-input" id="fenzhang">
								</div>
								<div class="layui-form-mid layui-word-aux">%</div>
							</div>
							<div class="layui-block">
								<label class="layui-form-label">微信手续费</label>
								<div class="layui-input-inline">
									<input type="text" name="poundage" id="shouxufei" lay-verify="number" placeholder="" autocomplete="off" class="layui-input">
								</div>
								<div class="layui-form-mid layui-word-aux">%</div>
							</div>
							<div class="layui-block widthauto">
								<label class="layui-form-label">活动时间</label>
								<div class="layui-input-inline" style="width:220px">
									<input type="radio" name="activityType" value="0" title="永久有效" lay-filter="timeType" checked="">
									<input type="radio" name="activityType" value="1" title="自定义" lay-filter="timeType">
								</div>
								<div class="layui-input-inline resetper">
									<input type="text" name="invalidTime" id="invalidTime" class="layui-input" lay-verify=""
									 placeholder="请选择时间">
								</div>
							</div>
						</div>
					</div>
					<blockquote class="layui-elem-quote consumeTit">
						<i class="leftline"></i>
						分账类型设置
					</blockquote>
					<div class="vipdetail_B_D">
						<div class="layui-form-item">
							<div class="layui-input-inline widthauto" id="setList">
								<!-- <input type="checkbox" name="like1" lay-skin="primary" title="会员买卡" value="1" checked="">
								<input type="checkbox" name="like1" lay-skin="primary" title="会员充值" value="2">
								<input type="checkbox" name="like1" lay-skin="primary" title="付费买券" value="3">
								<input type="checkbox" name="like1" lay-skin="primary" title="付费次/月卡" value="4">
								<input type="checkbox" name="like1" lay-skin="primary" title="会员消费" value="5">
								<input type="checkbox" name="like1" lay-skin="primary" title="门店收银" value="6"> -->
							</div>
						</div>
					</div>
					<div class="layui-form-item" style="width:100%">
                    <div class="layui-input-block" style="margin-left:0;margin-top:15px">
                        <div class="layui-footer" style="">
                            <button class="layui-btn" lay-submit="" lay-filter="add">提交</button>
                            
                        </div>
                        <!--<i class="layui-icon" lay-tips="推荐追求开发效率和缺乏前端开发经验的使用，后端开发者的最爱。">123123123</i>-->
                    </div>
                </div>
				</div>

				<div class="conBlock widthHalf">
					<blockquote class="layui-elem-quote consumeTit">
						<i class="leftline"></i>
						固定分账账户
						<div class="layui-btn layui-btn-xs subAcFullright" data-type="addDisP">
							添加分销人
						</div>
					</blockquote>
					<div class="vipdetail_B_D">
						<table class="layui-hide" id="Fixedaccount" lay-filter="shop"></table>
					</div>
				</div>
				<div class="conBlock widthHalf">
					<blockquote class="layui-elem-quote consumeTit">
						<i class="leftline"></i>
						分账规则设置
						<div class="layui-btn layui-btn-xs subAcFullright" data-type="addDisL">
							添加分销人等级
						</div>
					</blockquote>
					<div class="vipdetail_B_D">
						<table class="layui-hide" id="Separaterules" lay-filter="shop123"></table>
					</div>
				</div>
			</div>
		</div>
		<script type="text/html" id="switchBar">
			<input type="checkbox" name="recEnabled" lay-skin="switch" lay-filter="recEnabled" lay-text="启用|禁用" {{d.defaultFlag==1 ? 'checked' : ''}}  data-gradeNo="{{d.gradeNo}}" value="{{d.defaultFlag}}">
		</script>
		<script type="text/html" id="tool">
			<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
			<a class="layui-btn layui-btn-xs layui-btn-danger {{d.defaultFlag==1 ? 'hide' : ''}}" lay-event="delete">删除</a>
		</script>
		<script type="text/html" id="tool1">
			<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
			<a class="layui-btn layui-btn-xs layui-btn-danger {{d.defaultFlag==1 ? 'hide' : ''}}" lay-event="delete">删除</a>
		</script>
		<script src="../../common/config-sh.js"></script>
		<script src="../../common/utility.js"></script>
		<script>
			var setList = [
				{
					name:'会员买卡',
					num:1
				},
				{
					name:'会员充值',
					num:2
				},
				{
					name:'付费买券',
					num:3
				},
				{
					name:'付费次/月卡',
					num:4
				},
				{
					name:'会员消费',
					num:5
				},
				{
					name:'门店收银',
					num:6
				},
			]
			function fun_date(aa){
		        var date1 = new Date(),
		        time1=date1.getFullYear()+"-"+(date1.getMonth()+1)+"-"+date1.getDate();//time1表示当前时间
		        var date2 = new Date(date1);
		        date2.setDate(date1.getDate()+aa);
		        var time2 = date2.getFullYear()+"-"+(date2.getMonth()+1)+"-"+date2.getDate();
		        return time2
		    }
			var insNumber = JSON.parse(sessionStorage.getItem('userSh')).institutionNumber;
			var merNumber = JSON.parse(sessionStorage.getItem('userSh')).Number;
			layui.use(['table', 'laydate', 'element'], function() {
				var table = layui.table,
					$ = layui.$,
					element = layui.element,
					laydate = layui.laydate,
					form = layui.form;
					laydate.render({
					  elem: '#invalidTime'
					  ,range: true,
					  value:fun_date(-30) + ' - ' + fun_date(0)
					});
					/*---------- 积分时效 ----------*/
				form.on('radio(timeType)', function(data) {
					if (data.value == 0) {
						$('.resetper').css('display', 'none')
					} else if (data.value == 1) {
						$('.resetper').css('display', 'inline-block')
					}
				});
				var setStr = ''
				for(var i = 0 ; i < setList.length;i++){
					setStr +='<input type="checkbox" name="like1" lay-skin="primary" title="'+ setList[i].name +'" value="'+ setList[i].num +'" >'
				}
				$('#setList').html(setStr)
				form.render()
				CmsUtility.postAjaxCall2(
		                //系统设置
		               	CmsConfig.ServiceUrl.ApiRootUrlMeb + 'accountManage/getAccountRole',
		                {
		                	"merchantNumber":merNumber,
							"institutionNumber":insNumber,
		                },
		                function(data) {
		                    if (data.code == 1000) {
		                    	console.log(data.data.separateAccountsBill)
		                        form.val('cardAdd', {
					                "separateAccountsBill": data.data.separateAccountsBill*100,
					                "poundage":data.data.poundage*100,
					                "activityType":data.data.activityType,
					                "invalidTime":data.data.startTime.split(' ')[0] + ' - ' + data.data.endTime.split(' ')[0],

					            })
					            if (data.data.activityType == 0) {
									$('.resetper').css('display', 'none')
								} else if (data.data.activityType == 1) {
									$('.resetper').css('display', 'inline-block')
								}
					            var setStr = ''
								for(var i = 0 ; i < setList.length;i++){
									
									if(data.data.accountType.indexOf(setList[i].num) >=0){
										setStr +='<input type="checkbox" name="like1" lay-skin="primary" title="'+ setList[i].name +'" value="'+ setList[i].num +'" checked="">'
									}else{
										setStr +='<input type="checkbox" name="like1" lay-skin="primary" title="'+ setList[i].name +'" value="'+ setList[i].num +'" >'
									}
									
								}
								$('#setList').html(setStr)
								form.render()
		                    } else {
		                        layer.msg(data.msg)

		                    }
		                },
		                function(data) {
		                    console.log('222')
		                },
		                'get'
		            )

				//方法级渲染
				table.render({
					elem: '#Fixedaccount',
					url: CmsConfig.ServiceUrl.ApiRootUrlMeb + 'accountManage/getDistributorInfo?merchantNumber=' +
						merNumber,
					where:{
						"institutionNumber":insNumber,
						"fixedAccount":1,
						"name":'',
						"tell":''
						},
					method: "get",
					height: 'full-350',
					page: true,
					id: 'gradeList',
					response: {
						"statusCode": "1000", //解析接口状态
					},
					parseData: function(res) {
						if (res.data == null) {
							return
						}
						return {
							"code": res.code,
							"count": res.data.count,
							"data": res.data.distributorInfos,
						}
					},
					cols: [
						[{
							field: 'name',
							title: '姓名',
							align: 'center',
							width: 100,
							templet: function(data) {
								return '<span class="mebColor" style="color:' + data.gradeColor + '">' + data.name + '</span>'
							}
						}, {
							field: 'tell',
							title: '手机号',
							align: 'center',
							width: 120,
						}, {
							field: 'shopName',
							title: '分账比例(%)<br>(会员买卡 / 会员充值 / 付费买券 / 付费次/月卡)',
							align: 'center',
							width: 320,
							templet: function(data) {
								return data.memberCard + ' / ' + data.memberRecharge + ' / ' + data.payVouchers + ' / ' + data.payNext
							}
						}, {
							field: 'operation',
							title: '操作',
							align: 'left',
							toolbar: "#tool",
							minWidth: 150
						}]
					],
					done: function(res, curr, count) {
						parent.layer.closeAll('loading');
						if (res.data == null) {
							// layer.msg(res.msg)
						} else {

						}
					}
				});

				//消费记录
				table.render({
					elem: '#Separaterules',
					url: CmsConfig.ServiceUrl.ApiRootUrlMeb + 'accountManage/getDistributionLevel?merchantNumber=' +
						merNumber,
					where:{
						"institutionNumber":insNumber,
						"fixedAccount":0,
						"name":'',
						"tell":''
						},
					method: "get",
					height: 'full-350',
					page: true,
					id: 'Separaterules',
					response: {
						"statusCode": "1000", //解析接口状态
					},
					parseData: function(res) {
						if (res.data == null) {
							return
						}
						return {
							"code": res.code,
							"count": res.data.count,
							"data": res.data.resultMap,
						}
					},
					cols: [
						[{
							field: 'name',
							title: '分销人等级',
							align: 'center',
							templet: function(data) {
								return '<span class="mebColor" style="color:' + data.gradeColor + '">' + data.gradeName + '</span>'
							},
							width:110
						}, {
							field: 'shopName',
							title: '升级规则<br>(累计分账(元) / 累计交易(元) / 累计客户数(天))',
							align: 'center',
							templet: function(data) {
								return data.separateAmount + ' / ' + data.transactionAmount + ' / ' + data.extensionCount
							},
							width:280
						}, {
							field: 'shopName',
							title: '分账规则(%)<br>(会员买卡 / 会员充值 / 付费买券 / 付费次/月卡)',
							align: 'center',
							templet: function(data) {
								return (data.memberCard*100).toFixed(2) + ' / ' + (data.memberRecharge*100).toFixed(2) + ' / ' + (data.payVouchers*100).toFixed(2)	 + ' / ' + (data.payNext*100).toFixed(2)
							},
							width:280
						}, {
							field: 'operation',
							title: '操作',
							align: 'left',
							toolbar: "#tool1",
							width:120
						}]
					],
					done: function(res, curr, count) {
						parent.layer.closeAll('loading');
						if (res.data == null) {
							// layer.msg(res.msg)
						} else {

						}
					}
				});
				form.on('submit(add)', function(data, index) {
					console.log(data,index)
					var arr = new Array();
		            $("input:checkbox[name='like1']:checked").each(function(i){
		                arr[i] = $(this).val();
		            });
					console.log(arr)
					var tjData = new Object()
					tjData.merchantNumber = merNumber
					tjData.institutionNumber = insNumber
					tjData.paymentType = '1'
					//分账比例
					tjData.separateAccountsBill = ($('#fenzhang').val().trim()/100)
					//手续费比例
					tjData.poundage = ($('#shouxufei').val().trim()/100)
					//活动标识
					tjData.activityType = data.field.activityType
					tjData.startTime = data.field.invalidTime.split(' - ')[0] + ' 00:00:00'
					tjData.endTime = data.field.invalidTime.split(' - ')[1] + ' 23:59:59'
					tjData.accountType = arr.join('&')
					CmsUtility.postAjaxCall2(
		                //系统设置
		               	CmsConfig.ServiceUrl.ApiRootUrlMeb+'accountManage/setAccountRole',
		                tjData,
		                function(data) {
		                	layer.msg(data.msg)
		                    if (data.code == 1000) {
		                        
		                    } else {
		                        // layer.msg(data.msg)

		                    }
		                },
		                function(data) {
		                    console.log('222')
		                },
		                'get'
		            )
		            return false;
		        
				})
				table.on('tool(shop)', function(obj) {
					var data = obj.data;
					console.log(data)
					if(obj.event === 'edit') { //编辑
						layer.open({
							type: 2,
							title: '编辑',
							shade: 0.5,
							area: ['700px', '450px'],
							maxmin: false,
							resize: false,
							content: ['edit-fxMan.html'],
							success: function(layero, index) {
								// 获取子页面的iframe
								var iframe = window['layui-layer-iframe' + index];
								// 向子页面的全局函数child传参
								iframe.subPage(data)
							}
						});
					} else if(obj.event == 'delete'){
						layer.confirm('确定删除此（'+ data.name +'）分销人吗？', {
							icon: 3,
							title: '提示'
						}, function(index) {
							// 发送请求
							console.log(data)
							var addData = new Object()
							addData.id = data.id
							addData.gradeNumber = data.gradeNumber
							addData.fixedAccount = data.fixedAccount

							console.log(addData)
							// 发送请求
							CmsUtility.postAjaxCall2(
								//系统设置
								CmsConfig.ServiceUrl.ApiRootUrlMeb + 'accountManage/updatefixedAccount',
								addData,
								function(data){
									if(data.code == 1000){
										
										layer.msg('删除成功')
										layui.table.reload('gradeList');
									}else{
										layer.msg(data.msg)
									}
								},
								function(data){
									console.log('222')
								}
							)
						});
					}
				});
				table.on('tool(shop123)', function(obj) {
					var data = obj.data;
					console.log(data)
					if(obj.event === 'edit') { //编辑
						layer.open({
							type: 2,
							title: '编辑',
							shade: 0.5,
							area: ['600px', '80%'],
							maxmin: true,
							resize: false,
							content: ['edit-fxLevel.html'],
							success: function(layero, index) {
								// 获取子页面的iframe
								var iframe = window['layui-layer-iframe' + index];
								// 向子页面的全局函数child传参
								iframe.subPage(data)
							}
						});
					} else if(obj.event == 'delete'){
						layer.confirm('确定删除此（'+ data.gradeName +'）等级规则吗？', {
							icon: 3,
							title: '提示'
						}, function(index) {
							// 发送请求
							console.log(data.institutionumber)
							var addData = new Object()
							addData.gradeNumber = data.gradeNo
							addData.fixedAccount = data.fixedAccount
							addData.deletionFlag = '1'
							addData.merchantNumber = data.merchantNumber
							addData.institutionNumber = data.institutionumber
							addData.defaultID = data.defaultID
							console.log(addData)
							// 发送请求
							CmsUtility.postAjaxCall2(
								//系统设置
								 CmsConfig.ServiceUrl.ApiRootUrlMeb + 'accountManage/updateDistributionLevel',
								addData,
								function(data){
									if(data.code == 1000){
										
										layer.msg('删除成功')
										layui.table.reload('Separaterules');
									}else{
										layer.msg(data.msg)
									}
								},
								function(data){
									console.log('222')
								}
							)
						});
					}
				});
				var $ = layui.$,
					active = {
						addDisP: function() {
							layer.open({
								type: 2,
								title: '添加分销人',
								area: ['700px', '450px'],
								fixed: true, //不固定
								maxmin: false,
								content: 'add-fxMan.html'
							});
						},
						addDisL: function() {
							layer.open({
								type: 2,
								title: '添加分销人等级',
								area: ['600px', '80%'],
								fixed: true, //不固定
								maxmin: false,
								content: 'add-fxLevel.html'
							});
						}
					};
				$('.layui-btn').on('click', function() {
					var type = $(this).data('type');
					active[type] ? active[type].call(this) : '';
				});
			});
		</script>
	</body>

</html>
