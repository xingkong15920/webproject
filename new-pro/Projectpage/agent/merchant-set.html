<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title></title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="../../public/css/font.css">
    <link rel="stylesheet" href="../../public/css/xadmin.css">
    <script type="text/javascript" src="../../public/js/jquery-3.2.1.js"></script>
    <script type="text/javascript" src="../../public/js/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="../../public/lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../public/js/xadmin.js"></script>
    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]>
            <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
            <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
    <style type="text/css">
    .set {
        width: 110px;
        margin-right: 10px;
    }

    .layui-upload-img {
        width: 150px;
        height: 150px;
        border: 1px solid #e6e6e6;
        border-radius: 2px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .layui-input-inline {
        margin-left: 120px;
    }

    #demoText {
        width: 150px;
        height: auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #demoText span {
        margin-top: 10px;
    }

    #demoText a {
        margin-top: 10px;
    }

    .layui-tab-title li:first-child {
        width: 100px;
    }

    .layui-tab-title li {
        width: 100px;
    }

    .del {
        /* position: absolute;
                right: 0;
                top: 0; */
        width: 30px;
        height: 28px;
        line-height: 26px;
        margin-right: 10px;
        top: 1px;
        text-align: center;
        color: #c2c2c2;
        font-size: 20px;
        text-align: center;
        vertical-align: middle;
        display: inline-block;
        border: 1px solid #d2d2d2;
        margin-top: 3px;
        margin-left: -5px;
        text-indent: 2px;
        cursor: pointer;
    }

    .del:hover {
        background-color: #ff5722;
    }

    .layui-form-checkbox {
        margin-right: 0;
    }

    .layui-elem-quote {
        font-size: 18px;
    }

    .layui-elem-quote .layui-form-switch {
        width: 40px;
        margin: 0 15px;
        margin-top: 0;
    }

    .tips_red {
        color: red;
    }

    .tagsBody {
        max-width: 800px;
        border: 1px solid #e6e6e6;
        padding: 10px;
    }

    .tagsBody .layui-form-item:last-child {
        margin: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .site-demo-active {
        width: 100px;
    }

    .newTagsInput {
        width: calc(100% - 100px);
        margin-right: 10px;
    }

    #timing .layui-form-label {
        width: auto;
    }

    .invisible {
        background: url('../../public/images/icon-invisible.png') no-repeat;
        top: 10px;
        height: 19px;
    }

    .visible {
        background: url('../../public/images/icon-visible.png') no-repeat;
        top: 5px;
        height: 28px;
    }

    .layui-form-label {
        padding-left: 0;
        width: 100px;
    }

    .layui-input,
    .layui-textarea {
        display: block;
        width: 100%;
        padding-left: 10px;
    }
    </style>
</head>

<body id="iosiframe">
    <div class="x-nav">
        <span class="layui-breadcrumb">
            <a><cite>商户设置</cite></a>
        </span>
        <!-- <a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right" href="javascript:location.replace(location.href);"
             title="刷新">
                <i class="layui-icon layui-icon-refresh" style="line-height:30px"></i></a> -->
    </div>
    <div class="x-body">
        <div class="layui-row">
            <div class="layui-form" lay-filter="basic">
                <fieldset class="layui-elem-field layui-field-title" style="">
                    <legend style="font-weight: 500;">支付设置</legend>
                </fieldset>
                <div class="layui-input-item" id="payTip" style="display:none">
                    <span style="color:red;display:block;margin-left:30px">*该商户暂未开通支付方式</span>
                </div>
                <div class="layui-form-item" id="ali" style="display:none">
                    <label class="layui-form-label">支付宝：</label>
                    <div class="layui-input-inl" style="width:400px;float:left;margin-left:20px">
                        <!--  <input type="text" name="merchantNumber" lay-verify="title"  placeholder="商户编号" class="layui-input" id="merchantNumber"> -->
                        <select name="alisel" id="alisel" lay-filter="alisel">
                        </select>
                        <!-- <input type="text" name="" lay-verify="" placeholder="" class="layui-input" disabled="disabled " class="display:inline-block"> -->
                    </div>
                    <div class="layui-input-block" style="width:400px;float:left;margin-left:30px">
                        <!--  <input type="text" name="merchantNumber" lay-verify="title"  placeholder="商户编号" class="layui-input" id="merchantNumber"> -->
                        <input type="text" name="aliche" lay-verify="title" placeholder="" class="layui-input" disabled="disabled">
                    </div>
                </div>
                <div class="layui-form-item" id="wx" style="display:none">
                    <label class="layui-form-label">微信：</label>
                    <div class="layui-input-inl" style="width:400px;float:left;margin-left:20px">
                        <!--  <input type="text" name="merchantNumber" lay-verify="title"  placeholder="商户编号" class="layui-input" id="merchantNumber"> -->
                        <select name="wxsel" id="wxsel" lay-filter="wxsel">
                        </select>
                        <!-- <input type="text" name="" lay-verify="" placeholder="" class="layui-input" disabled="disabled " class="display:inline-block"> -->
                    </div>
                    <div class="layui-input-block" style="width:400px;float:left;margin-left:30px">
                        <!--  <input type="text" name="merchantNumber" lay-verify="title"  placeholder="商户编号" class="layui-input" id="merchantNumber"> -->
                        <input type="text" name="wxche" lay-verify="title" placeholder="" class="layui-input" disabled="disabled">
                    </div>
                </div>
                <div class="layui-form-item" id="ysf" style="display:none">
                    <label class="layui-form-label">云闪付：</label>
                    <div class="layui-input-inl" style="width:400px;float:left;margin-left:20px">
                        <!--  <input type="text" name="merchantNumber" lay-verify="title"  placeholder="商户编号" class="layui-input" id="merchantNumber"> -->
                        <select name="ysfsel" id="ysfsel" lay-filter="ysfsel">
                        </select>
                        <!-- <input type="text" name="" lay-verify="" placeholder="" class="layui-input" disabled="disabled " class="display:inline-block"> -->
                    </div>
                    <div class="layui-input-block" style="width:400px;float:left;margin-left:30px">
                        <!--  <input type="text" name="merchantNumber" lay-verify="title"  placeholder="商户编号" class="layui-input" id="merchantNumber"> -->
                        <input type="text" name="ysfche" lay-verify="title" placeholder="" class="layui-input" disabled="disabled">
                    </div>
                </div>
                <div class="layui-input-block" id="payOff" style="display:none">
                    <input type="button" class="layui-btn" lay-submit="" lay-filter="create" value="立即提交" id="sub">
                </div>
            </div>
            <div class="layui-form" lay-filter="basic1">
                <fieldset class="layui-elem-field layui-field-title" style="">
                    <legend style="font-weight: 500;">商户设置</legend>
                </fieldset>
                <div class="layui-form-item">
                    <label class="layui-form-label">商户名称：</label>
                    <div class="layui-input-block" style="width:830px">
                        <!--  <input type="text" name="merchantNumber" lay-verify="title"  placeholder="商户编号" class="layui-input" id="merchantNumber"> -->
                        <input type="text" name="merchantName" lay-verify="required" placeholder="" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">联系人：</label>
                    <div class="layui-input-block" style="width:830px">
                        <!--  <input type="text" name="merchantNumber" lay-verify="title"  placeholder="商户编号" class="layui-input" id="merchantNumber"> -->
                        <input type="text" name="contactsName" lay-verify="required" placeholder="" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">联系电话：</label>
                    <div class="layui-input-block" style="width:830px">
                        <!--  <input type="text" name="merchantNumber" lay-verify="title"  placeholder="商户编号" class="layui-input" id="merchantNumber"> -->
                        <input type="text" name="registerCell" lay-verify="phone" placeholder="" class="layui-input">
                    </div>
                </div>
                <div class="layui-input-block">
                    <input type="button" class="layui-btn" lay-submit="" lay-filter="create1" value="立即提交" id="sub">
                </div>
            </div>
            <div class="layui-form" lay-filter="basic2" id="advBox" style="display:none">
                <fieldset class="layui-elem-field layui-field-title" style="">
                    <legend style="font-weight: 500;">刷脸广告设置</legend>
                </fieldset>
                <div class="layui-form-item">
                    <label class="layui-form-label">刷脸广告：</label>
                    <div class="layui-input-block">
                        <input type="checkbox" name="advertJurisdiction" lay-skin="switch" lay-filter="consumptionPreferences1" lay-text="开|关">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="../../common/config-agent.js"></script>
    <script src="../../common/utility.js"></script>
    <script>
    var serverUrl = 'http://192.168.110.190:5002/'
    // var userNumber = JSON.parse(sessionStorage.getItem('organUser')).institutionNumber;

    var code1;
    var jgData;
    var merchantca = false;
    var type;
    var logoUrl = '';
    var merchantNumber = CmsUtility.getQueryString('merchantNumber')
    var merchantName = CmsUtility.getQueryString('merchantName')
    var contactsName = CmsUtility.getQueryString('userName')
    var registerCell = CmsUtility.getQueryString('registerCell')
    var advertJurisdiction = CmsUtility.getQueryString('advertJurisdiction')

    console.log(merchantNumber)
    var merchantPayInfo = new Object()
    var pyList;
    var aliOff, wxOff, ysfOff;
    var userNumber = JSON.parse(sessionStorage.getItem('agentUser')).Number;
    layui.use(['laydate', 'table', 'form', 'laytpl', 'upload'], function() {
        layui.$.support.cors = true; //允许ajax跨域
        var $ = layui.jquery,
            upload = layui.upload,
            laydate = layui.laydate,
            table = layui.table,
            form = layui.form,
            laytpl = layui.laytpl;
        form.val('basic1', {
            "merchantName": merchantName,
            "contactsName": contactsName,
            "registerCell": registerCell,
        })
        form.val('basic2', {
            "advertJurisdiction": advertJurisdiction == 0 ? true : false,
        })

        if (JSON.parse(sessionStorage.getItem("agentUser")).advertJurisdiction == 1) {
            $("#advBox").css('display', 'none');
        } else {
            $("#advBox").css('display', 'block');
        }
        //获取已审核商户通道通道中的支付方式
        CmsUtility.postAjaxCall(
            //系统设置
            'agMerchant/getMerPayChannels', {
                "merchantNumber": merchantNumber
            },
            function(data) {
                if (data.code == 1000) {
                    var list = data.data
                    pyList = data.data
                    for (var i = 0; i < list.length; i++) {
                        if (list[i].onePaymentTypeINT == 0) {
                            if (list[i].interfaceSwitch != 0) {
                                $('#ali').hide()
                                aliOff = false
                            } else {
                                $('#ali').show()
                                aliOff = true
                            }
                            console.log(list[i])
                            var listdata = list[i].date
                            var str = '<option value="">请选择通道</option>'
                            for (var j = 0; j < listdata.length; j++) {
                                str += '<option value="' + listdata[j].subaccountNumber + '">' + listdata[j].paymentName + ' / ' + listdata[j].subaccountNumber + '</option>'
                            }
                            $('#alisel').html(str)
                            console.log(str)
                            form.render()
                        }
                        if (list[i].onePaymentTypeINT == 1) {
                            console.log(list[i])
                            var listdata = list[i].date

                            if (list[i].interfaceSwitch != 0) {
                                $('#wx').hide()
                                wxOff = false
                            } else {
                                $('#wx').show()
                                wxOff = true
                            }
                            var str = '<option value="">请选择通道</option>'
                            for (var j = 0; j < listdata.length; j++) {
                                str += '<option value="' + listdata[j].subaccountNumber + '">' + listdata[j].paymentName + ' / ' + listdata[j].subaccountNumber + '</option>'
                            }
                            $('#wxsel').html(str)
                            console.log(str)
                            form.render()
                        }
                        if (list[i].onePaymentTypeINT == 3) {
                            console.log(list[i])
                            var listdata = list[i].date
                            if (list[i].interfaceSwitch != 0) {
                                $('#ysf').hide()
                                ysfOff = false
                            } else {
                                $('#ysf').show()
                                ysfOff = true
                            }
                            var str = '<option value="">请选择通道</option>'
                            for (var j = 0; j < listdata.length; j++) {
                                str += '<option value="' + listdata[j].subaccountNumber + '">' + listdata[j].paymentName + ' / ' + listdata[j].subaccountNumber + '</option>'
                            }
                            $('#ysfsel').html(str)
                            console.log(str)
                            if (aliOff != true && wxOff != true && ysfOff != true) {
                                $('#payOff').hide()
                                $('#payTip').show()
                            } else {
                                $('#payOff').show()
                                $('#payTip').hide()
                            }
                        }
                    }
                    formDetail()
                } else {
                    layer.msg(data.msg)

                }
            },
            function(data) {
                console.log('222')
            },
            'get'
        )

        function formDetail() {
            CmsUtility.postAjaxCall(
                //系统设置
                'agMerchant/getMerchantTD', {
                    "merchantNumber": merchantNumber
                },
                function(data) {
                    if (data.code == 1000) {
                        var list = data.data
                        for (var i = 0; i < list.length; i++) {
                            if (list[i].onePaymentTypeINT == 0) {
                                if (list[i].date.length == 0) {
                                    form.val('basic', {
                                        "alisel": '',
                                        "aliche": '暂未选择支付子账号'
                                    })
                                }
                                if (list[i].date.length == 1) {
                                    form.val('basic', {
                                        "alisel": list[i].date[0].subaccountNumber,
                                        "aliche": list[i].date[0].subaccountNumber
                                    })
                                }
                                if (list[i].date.length > 1) {
                                    var str = ''
                                    for (var j = 0; j < list[i].date.length; j++) {
                                        str += list[i].date[j].subaccountNumber + ' | '
                                    }
                                    form.val('basic', {
                                        "alisel": list[i].date[0].subaccountNumber,
                                        "aliche": str
                                    })
                                }

                            }
                            if (list[i].onePaymentTypeINT == 1) {
                                if (list[i].date.length == 0) {
                                    form.val('basic', {
                                        "wxsel": '',
                                        "wxche": '暂未选择支付子账号'
                                    })
                                }
                                if (list[i].date.length == 1) {
                                    form.val('basic', {
                                        "wxsel": list[i].date[0].subaccountNumber,
                                        "wxche": list[i].date[0].subaccountNumber
                                    })
                                }
                                if (list[i].date.length > 1) {
                                    var str = ''
                                    for (var j = 0; j < list[i].date.length; j++) {
                                        str += list[i].date[j].subaccountNumber + ' | '
                                    }
                                    form.val('basic', {
                                        "wxsel": list[i].date[0].subaccountNumber,
                                        "wxche": str
                                    })
                                }

                            }
                            if (list[i].onePaymentTypeINT == 3) {
                                if (list[i].date.length == 0) {
                                    form.val('basic', {
                                        "ysfsel": '',
                                        "ysfche": '暂未选择支付子账号'
                                    })
                                }
                                if (list[i].date.length == 1) {
                                    form.val('basic', {
                                        "ysfsel": list[i].date[0].subaccountNumber,
                                        "ysfche": list[i].date[0].subaccountNumber
                                    })
                                }
                                if (list[i].date.length > 1) {
                                    var str = ''
                                    for (var j = 0; j < list[i].date.length; j++) {
                                        str += list[i].date[j].subaccountNumber + ' | '
                                    }
                                    form.val('basic', {
                                        "ysfsel": list[i].date[0].subaccountNumber,
                                        "ysfche": str
                                    })
                                }

                            }
                        }
                        form.render()
                        // form.val('basic', {
                        //     "alisel":data.data
                        //     "aliche":data.data
                        //     "wxsel":data.data
                        //     "wxche":data.data
                        //     "ysfsel":data.data
                        //     "ysfche":data.data
                        // })
                    } else {
                        layer.msg(data.msg)

                    }
                },
                function(data) {
                    console.log('222')
                },
                'get'
            )
        }

        function compare(property) {
            return function(a, b) {
                var value1 = a[property];
                var value2 = b[property];
                return value1 - value2;
            }
        }
        //会员分组设置
        var userNumber = JSON.parse(sessionStorage.getItem('agentUser')).Number;
        // $('#isnNumber').val(JSON.parse(sessionStorage.getItem('userSh')).institutionNumber)
        // $('#merchangtNumber').val(JSON.parse(sessionStorage.getItem('userSh')).Number)
        // form.render()
        /*---------- 监听开关 ----------*/
        // form.on('switch(timePreferences)', function(data) { //计时开关
        //     if (data.elem.checked == true) {
        //         $('#timing').show()
        //         data.elem.value = "0"
        //         console.log(data.elem.value)
        //     } else if (data.elem.checked == false) {
        //         data.elem.value = "1"
        //         console.log(data.elem.value)
        //         $('#timing').hide()
        //     }
        // });
        form.on('select(alisel)', function(data) {
            console.log(data.value)
            if (data.value == '') {
                form.val('basic', {

                    "aliche": '暂未选择支付通道'
                })
                return
            }
            form.val('basic', {

                "aliche": data.value
            })
            form.render()

        })
        form.on('select(wxsel)', function(data) {
            console.log(data.value)
            if (data.value == '') {
                form.val('basic', {

                    "wxche": '暂未选择支付通道'
                })
                return
            }
            form.val('basic', {

                "wxche": data.value
            })
            form.render()

        })
        form.on('select(ysfsel)', function(data) {
            console.log(data.value)
            if (data.value == '') {
                form.val('basic', {

                    "ysfche": '暂未选择支付通道'
                })
                return
            }
            form.val('basic', {

                "ysfche": data.value
            })
            form.render()

        })
        form.on('submit(create)', function(data) {
            var tipStr = '';
            console.log(data.field)
            var jData = data.field
            console.log(pyList)
            // if(data.field.nuber)
            var tjData = new Object();
            tjData.merchantNumber = merchantNumber
            var paramJson = new Array()
            for (var i = 0; i < pyList.length; i++) {
                var oob = new Object()
                var cName
                if (pyList[i].onePaymentTypeINT == 0) {
                    oob.institutionNumber = JSON.parse(sessionStorage.getItem('agentUser')).institutionNumber
                    oob.subaccountNumber = jData.alisel
                    oob.paymentChannel = ''
                    oob.paymentTypeID = pyList[i].paymentTypeID
                    for (var j = 0; j < pyList[i].date.length; j++) {
                        if (jData.alisel == pyList[i].date[j].subaccountNumber) {
                            oob.paymentChannel = pyList[i].date[j].paymentChannel
                            cName = pyList[i].date[j].paymentName
                        }
                    }
                    if (aliOff == true) {
                        if (oob.paymentChannel == '') {
                            tipStr = '支付宝：未选择支付通道' + '</br>'
                        } else {
                            tipStr = '支付宝：' + cName + '/' + oob.subaccountNumber + '</br>'
                        }
                    }


                    paramJson.push(oob)
                }
                if (pyList[i].onePaymentTypeINT == 1) {
                    oob.institutionNumber = JSON.parse(sessionStorage.getItem('agentUser')).institutionNumber
                    oob.subaccountNumber = jData.wxsel
                    oob.paymentTypeID = pyList[i].paymentTypeID
                    oob.paymentChannel = ''
                    for (var j = 0; j < pyList[i].date.length; j++) {
                        if (jData.wxsel == pyList[i].date[j].subaccountNumber) {
                            oob.paymentChannel = pyList[i].date[j].paymentChannel
                            cName = pyList[i].date[j].paymentName
                        }
                    }
                    if (wxOff == true) {
                        if (oob.paymentChannel == '') {
                            tipStr += '微信：未选择支付通道' + '</br>'
                        } else {
                            tipStr += '微信：' + cName + '/' + oob.subaccountNumber + '</br>'
                        }
                    }

                    paramJson.push(oob)
                }
                if (pyList[i].onePaymentTypeINT == 3) {
                    oob.institutionNumber = JSON.parse(sessionStorage.getItem('agentUser')).institutionNumber
                    oob.subaccountNumber = jData.ysfsel
                    oob.paymentTypeID = pyList[i].paymentTypeID
                    oob.paymentChannel = ''
                    for (var j = 0; j < pyList[i].date.length; j++) {
                        if (jData.ysfsel == pyList[i].date[j].subaccountNumber) {
                            oob.paymentChannel = pyList[i].date[j].paymentChannel
                            cName = pyList[i].date[j].paymentName
                        }
                    }
                    if (ysfOff == true) {
                        if (oob.paymentChannel == '') {
                            tipStr += '云闪付：未选择支付通道' + '</br>'
                        } else {
                            tipStr += '云闪付：' + cName + '/' + oob.subaccountNumber + '</br>'
                        }
                    }

                    paramJson.push(oob)
                }
            }
            console.log(paramJson)
            tjData.paramJson = JSON.stringify(paramJson)

            layer.confirm(tipStr, { icon: 0, title: '通道提示' }, function(index) {
                //do something
                var index = layer.load(2, { shade: [0.4, '#393D49'] })
                CmsUtility.postAjaxCall(
                    //系统设置
                    'agMerchant/updateMerPayChannels',
                    tjData,
                    function(data) {
                        layer.closeAll()
                        if (data.code == 1000) {
                            // type111 = 2
                            layer.close(index)
                            layer.msg(data.msg)
                            setTimeout(function() {
                                parent.layui.table.reload('merchantlist')
                            }, 500)

                        } else {
                            layer.msg(data.msg)

                        }
                    },
                    function(data) {
                        console.log('222')
                    }
                )
                // layer.close(index);
            });
            return false

        });
        form.on('submit(create1)', function(data) {
            console.log(data)
            var tjData = data.field
            tjData.institutionNumber = JSON.parse(sessionStorage.getItem('agentUser')).institutionNumber
            tjData.merchantNumber = merchantNumber
            var index = layer.load(2, { shade: [0.4, '#393D49'] })
            CmsUtility.postAjaxCall(
                //系统设置
                'agMerchant/updateMerchant',
                tjData,
                function(data) {
                    layer.closeAll()
                    if (data.code == 1000) {
                        // type111 = 2
                        layer.msg(data.msg)
                        setTimeout(function() {
                            parent.layui.table.reload('merchantlist')
                        }, 500)


                    } else {
                        layer.msg(data.msg)

                    }
                },
                function(data) {
                    console.log('222')
                }
            )
            return false
        })
        form.on('switch(consumptionPreferences1)', function(data) {
            // layer.tips('广告状态：' + (this.checked ? '已开启' : '已关闭'), data.othis)
            var tjData = new Object();
            // tjData.agentNumber = userNumber;
            tjData.merchantNumber = merchantNumber;
            tjData.advertJurisdiction = this.checked ? '0' : '1';
            var index = layer.load(2, { shade: [0.4, '#393D49'] })
            CmsUtility.postAjaxCall(
                //系统设置
                CmsConfig.addressUrl.Agent.changeMerAdState,
                tjData,
                function(data) {
                    layer.closeAll()
                    if (data.code == 1000) {

                        layer.msg(data.msg)
                        setTimeout(function() {
                            parent.layui.table.reload('merchantlist')
                        }, 500)
                    } else {
                        layer.msg(data.msg)

                    }
                },
                function(data) {
                    console.log('222')
                }
            )
        });
    })
    </script>
</body>

</html>