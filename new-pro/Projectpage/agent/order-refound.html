<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title></title>
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=1, user-scalable=0">
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <link rel="stylesheet" href="../../public/css/xadmin.css">
    <script type="text/javascript" src="../../public/js/jquery-3.2.1.js"></script>
    <link rel="stylesheet" href="../../public/css/style-baobiao.css">
    <script type="text/javascript" src="../../public/lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../public/js/xadmin.js"></script>
    <style>
    /* *{
                font-size: 14px;
            } */
    /* .layui-table-cell {
                height: auto;
                line-height: initial;
            } */
    .layui-table-cell {
        height: auto;
    }
    </style>
    <style type="text/css">
    .index-zs .layui-col-md5 {
        width: 20%;
        text-align: center;
    }

    .homelistitle {
        font-size: 1.2rem;
        margin-bottom: 10px;
        color: #999;
    }

    .homelistc:last-child {
        margin-bottom: 20px;
    }

    .homelistc {
        font-size: 1.6rem;
        font-weight: 600;
    }

    .homelistc span {
        display: block;
        font-size: 1.6rem;
        font-weight: 600;
    }

    .homelistc span i {
        font-style: normal;
        font-size: 1.6rem;
        font-weight: 600;
    }

    p {
        font-size: 16px;
    }
    #btnBox .layui-btn{
        width: 100px;
        border-radius: 10px;
        margin-right: 10px;
    }
    </style>
</head>

<body>
    <div class="x-nav">
        <span class="layui-breadcrumb">
            <a href="">首页</a>
            <a><cite>订单管理</cite></a>
        </span>
        <a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right" href="javascript:location.replace(location.href);" title="刷新">
            <i class="layui-icon" style="line-height:30px">ဂ</i></a>
    </div>
    <div class="x-body">
        <div class="layui-form layui-row">
            <div class="layui-input-inline text">
                <div class="layui-input-clear"><i class="layui-icon layui-unselect layui-tab-close">ဆ</i></div>
                <input id="shopName" type="text" name="userName" placeholder="商户名称" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-input-inline text">
                <div class="layui-input-clear"><i class="layui-icon layui-unselect layui-tab-close">ဆ</i></div>
                <input id="orderNumber" type="text" name="orderId" placeholder="订单号" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-input-inline text">
                <div class="layui-input-clear"><i class="layui-icon layui-unselect layui-tab-close">ဆ</i></div>
                <input id="refundOrderNumber" type="text" name="orderId" placeholder="退款订单号" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-input-inline">
                <input type="text" class="layui-input" placeholder="创建时间" name="startTime" id="startTime">
            </div>
            <div class="layui-input-inline">
                <input type="text" class="layui-input" placeholder="成功时间" name="endTime" id="endTime">
            </div>
            <div class="layui-input-inline">
                <select id="oneTransactionType" name="transactionType">
                    <option value="">支付方式</option>
                    <option value="Alipay_Pay">支付宝支付</option>
                    <option value="WeChat_Pay">微信支付</option>
                    <option value="UnionPay_Pay">云闪付</option>

                    <option value="Pos_Pay">银联</option>
                </select>
            </div>
            <div class="layui-input-inline">
                <select name="twoTransactionType" id="twoTransactionType">
                    <option value="">支付类型</option>
                    <option value="0">条码支付</option>
                    <option value="1">动态二维码支付</option>
                    <option value="2">小程序支付</option>
                    <option value="5">公众号支付</option>
                    <option value="6">服务窗支付</option>
                    <option value="7">预授权</option>
                    <option value="8">刷脸支付</option>
                    <option value="11">刷卡支付</option>
                </select>
            </div>
            <div class="layui-input-inline">
                <select name="orderState" id="orderState">
                    <option value="4">全部退款</option>
                    <option value="5">部分退款</option>
                </select>
            </div>
            <!-- <div class="layui-input-inline">
                <select id="orderState" name="orderState">
                    <option value="10">订单类型</option>
                    <option value="1">交易成功</option>
                    <option value="5">部分退款</option>
                    <option value="4">全部退款</option>
                </select>
            </div> -->
            <button class="layui-btn" id="search"><i class="layui-icon">&#xe615;</i></button>
        </div>
        <div class="layui-row" id="btnBox" style="margin-bottom:10px;margin-top:10px">
            <button type="button" class="layui-btn layui-btn-primary fl" onclick="jyClick(0,0)">今天</button>
            <button type="button" class="layui-btn layui-btn-primary fl" onclick="jyClick(1,1)">昨天</button>
            <button type="button" class="layui-btn layui-btn-primary fl" onclick="jyClick(2,2)">最近7天</button>
            <button type="button" class="layui-btn layui-btn-primary fl" onclick="jyClick(3,3)">近30天</button>
        </div>
        <!--  <div class="baobiao" style="width:100%;height:143px">
            <div class="baobiao-col-1" style="padding-left: 0;">
                <div class="baobiaoK">
                    <div class="baobiaolist" style="line-height:52px;font-size:16px">
                        笔数汇总
                    </div>
                    <div style="line-height:50px;font-size:16px" id="count">
                        0
                    </div>
                </div>
            </div>
            <div class="baobiao-col-1 jianhao" style="padding-right:0;position:relative">
                <div class="baobiaoK">
                    <div class="baobiaolist" style="line-height:52px;font-size:16px">
                        交易金额
                    </div>
                    <div style="line-height:50px;font-size:16px" id="transactionAmount">
                        0元
                    </div>
                </div>
            </div>
            <div style="width:20px;height:143px;float:left;margin-left:15px;font-size: 50px;
    line-height: 154px;
    text-align: center;">-</div>
            <div class="baobiao-col-1 jianhao" style="padding-right: 0;">
                <div class="baobiaoK">
                    <div class="baobiaolist" style="line-height:52px;font-size:16px">
                        退款额
                    </div>
                    <div style="line-height:50px;font-size:16px" id="refundAmount">
                        0元
                    </div>
                </div>
            </div>
            <div style="width:20px;height:143px;float:left;margin-left:15px;font-size: 50px;
    line-height: 154px;
    text-align: center;">-</div>
            <div class="baobiao-col-1 jianhao" style="padding-right: 0;">
                <div class="baobiaoK">
                    <div class="baobiaolist" style="line-height:52px;font-size:16px">
                        手续费
                    </div>
                    <div style="line-height:50px;font-size:16px" id="shopPoundage">
                        0元
                    </div>
                </div>
            </div>
            <div style="width:20px;height:143px;float:left;margin-left:15px;font-size: 50px;
    line-height: 154px;
    text-align: center;">=</div>
            <div class="baobiao-col-1 denghao" style="padding-right: 0;">
                <div class="baobiaoK">
                    <div class="baobiaolist" style="line-height:52px;font-size:16px">
                        实收金额
                    </div>
                    <div style="line-height:50px;font-size:16px" id="settlementAmount">
                        0元
                    </div>
                </div>
            </div>
        </div> -->
        <table class="layui-hide" id="LAY_table_bill" lay-filter="bill" style="font-size:14px"></table>
    </div>
    <script type="text/html" id="tool">
        <a class="layui-btn layui-btn-xs" lay-event="detail">查看</a>
            
        </script>
    <script src="../../common/config-agent.js"></script>
    <script src="../../common/utility.js"></script>
    <script>
    // <a class="layui-btn layui-btn-xs" lay-event="instep" style="margin-left:0">同步</a>
    var newData;

    function fun_date(aa) {
        var date1 = new Date(),
            time1 = date1.getFullYear() + "-" + (date1.getMonth() + 1) + "-" + date1.getDate(); //time1表示当前时间
        var date2 = new Date(date1);
        date2.setDate(date1.getDate() + aa);
        var time2 = date2.getFullYear() + "-" + (date2.getMonth() + 1) + "-" + date2.getDate();

        var a = time2.split('-')[0],
            b = time2.split('-')[1],
            c = time2.split('-')[2]
        if (b < 10) {
            b = 0 + b
        }
        if (c < 10) {
            c = 0 + c
        }
        return a + '-' + b + '-' + c
    }

    function changeList(data) {
        var dataL = data.transactionReceiptShareProfitList
        for (var i = 0; i < dataL.length; i++) {
            if (dataL[i].orderState == 1) {
                dataL[i].orderState1 = "交易成功"
            }
            if (dataL[i].orderState == 2) {
                dataL[i].orderState1 = "已结算"
            }
            if (dataL[i].orderState == 3) {
                dataL[i].orderState1 = "失败"
            }
            if (dataL[i].orderState == 4) {
                dataL[i].orderState1 = "全部退款"
            }
            if (dataL[i].orderState == 5) {
                dataL[i].orderState1 = "部分退款"
            }
            if (dataL[i].orderState == 6) {
                dataL[i].orderState1 = "异常订单"
            }
            if (dataL[i].orderState == 7) {
                dataL[i].orderState1 = "退款中"
            }

        }
        console.log(data)
        newData = data.agentOrderList
        return dataL
    }
    window.onload = function() {
        var beginDate = fun_date(-6);

        var endDate = fun_date(0);
        layui.use(['table', 'laytpl', 'laydate'], function() {

            var table = layui.table,
                form = layui.form,
                laydate = layui.laydate
            laytpl = layui.laytpl,
                $ = layui.jquery;

            laydate.render({
                elem: '#startTime', //指定元素
                value: beginDate
            });
            laydate.render({
                elem: '#endTime',
                value: endDate
            });
            console.log()

            var userNumber = JSON.parse(sessionStorage.getItem('agentUser')).Number;
            var agentLevel = JSON.parse(sessionStorage.getItem('agentUser')).agentLevel;
            //方法级渲染
            console.log($('#startTime').val())
            window.jyClick = function(data, data1) {
               
            $('.fl').attr('class', 'layui-btn layui-btn-primary fl')
            $('.fl').eq(data).attr('class', 'layui-btn  fl')
            switch (data1) {
                case 0:
                    $('#startTime').val(CmsUtility.fun_date(0))
                    $('#endTime').val(CmsUtility.fun_date(0))
                    break;
                case 1:
                    $('#startTime').val(CmsUtility.fun_date(-1))
                    $('#endTime').val(CmsUtility.fun_date(-1))
                    break;
                case 2:
                    $('#startTime').val(CmsUtility.fun_date(-6))
                    $('#endTime').val(CmsUtility.fun_date(0))
                    break;
                case 3:
                    $('#startTime').val(CmsUtility.fun_date(-29))
                    $('#endTime').val(CmsUtility.fun_date(0))
                    break;
                default:
                    // statements_def
                    break;
            }
            tableRender()

        }
            function tableRender() {
                var index = layer.load(2, { shade: [0.4, '#393D49'] })
                table.render({
                    url: CmsConfig.ServiceUrl.ApiRootUrl + CmsConfig.addressUrl.Agent.selectOrderList + '?agentNumber=' + userNumber,
                    where: {
                        "agentLevel": agentLevel,
                        "batch": $('#orderNumber').val().trim(),
                        "merchantName": $('#shopName').val().trim(),
                        "startTime": $('#startTime').val() + ' ' + '00:00:00',
                        "endTime": $('#endTime').val() + ' ' + '23:59:59',
                        "oneTransactionType": $('#oneTransactionType').val(),
                        "orderState": $('#orderState').val(),
                        "refundOrderNumber": $('#refundOrderNumber').val().trim(),
                        "twoTransactionType": $('#twoTransactionType').val()
                    },
                    elem: '#LAY_table_bill',
                    page: true,
                    height: 'full-200',
                    id: 'billlist',
                    response: {
                        "statusCode": "1000", //解析接口状态
                    },
                    parseData: function(res) {
                        if (res.data == null) {
                            return
                        }
                        return {
                            "msg": res.msg,
                            "code": res.code,
                            "count": res.data.count,
                            "data": changeList(res.data),
                        }
                    },
                    cols: [
                        [{
                            title: '商户编号/商户名称',
                            align: 'center',
                            templet: function(data) {
                                return data.merchantNumber + ' <br /> ' + data.merchantName
                            },
                        }, {
                            templet: function(data) {
                                return data.batch
                            },
                            title: '订单号',
                            align: 'center',
                        }, {
                            templet: function(data) {
                                return data.refundOrderNumber + '<br />' + data.paymentOrderNumber
                            },
                            title: '退款订单号/通道订单号',
                            align: 'center',
                        }, {
                            field: 'transactionAmount',
                            title: '退款金额',
                            align: 'center',

                            templet: function(data) {
                                return '￥' + data.transactionAmount
                            }
                        }, {
                            templet: function(data) {
                                return data.orderTime + '</br>' + data.transactionTime
                            },
                            title: '提交时间/成功时间',
                            align: 'center',
                        }, {
                            field: 'subaccountNumber',
                            title: '支付方式',
                            align: 'center',
                            templet: function(data) {
                                var oneZ, twoZ
                                switch (data.onePaymentTypeName) {
                                    case '0':
                                        oneZ = '支付宝'
                                        break;
                                    case '1':
                                        oneZ = '微信'
                                        break;
                                    case '2':
                                        oneZ = '京东钱包'
                                        break;
                                    case '3':
                                        oneZ = '云闪付'
                                        break;
                                    case '7':
                                        oneZ = '银联'
                                        break;
                                    default:
                                        oneZ = '--'
                                        break;
                                }
                                switch (data.twoPaymentTypeName) {
                                    case '0':
                                        twoZ = '条码支付'
                                        break;
                                    case '1':
                                        twoZ = '动态二维码支付'
                                        break;
                                    case '2':
                                        twoZ = '小程序支付'
                                        break;
                                    case '3':
                                        twoZ = 'APP支付'
                                        break;
                                    case '4':
                                        twoZ = 'H5支付'
                                        break;
                                    case '5':
                                        twoZ = '公众号支付'
                                        break;
                                    case '6':
                                        twoZ = '服务窗支付'
                                        break;
                                    case '7':
                                        twoZ = '预授权'
                                        break;
                                    case '8':
                                        twoZ = '刷脸支付'
                                        break;
                                    case '11':
                                        twoZ = '刷卡支付'
                                        break;
                                    case '12':
                                        twoZ = '刷卡支付'
                                        break;
                                    default:
                                        twoZ = '--'
                                        break;
                                }
                                return oneZ + '</br>' + twoZ
                            }
                        }, {
                            field: 'remark',
                            title: '订单描述',
                            align: 'center',
                        }, {
                            field: 'orderState1',
                            title: '状态',
                            align: 'center',

                        }, {
                            field: 'operation',
                            title: '操作',
                            toolbar: "#tool",
                            align: 'center',
                            minWidth: 120
                        }]
                    ],
                    done: function(res, curr, count) {
                        // console.log(newData)
                        // console.log(curr)
                        if (res.code != 1000) {
                            $("#count").html('0')
                            $("#transactionAmount").html('0元')
                            $("#refundAmount").html('0元')
                            $("#shopPoundage").html('0元')
                            $("#settlementAmount").html('0元')
                        } else {
                            $("#count").html(newData.count)
                            $("#transactionAmount").html(newData.transactionAmount + '元')
                            $("#refundAmount").html(newData.refundAmount + '元')
                            $("#shopPoundage").html(newData.shopPoundage + '元')
                            $("#settlementAmount").html(newData.settlementAmount + '元')
                        }




                        layer.closeAll()
                    }
                });
            }
            setTimeout(function() {
                tableRender()
            }, 500)

            $('#search').click(function() {
                tableRender()
                $('.fl').attr('class', 'layui-btn layui-btn-primary fl')
            })
            // 根據條件重载表格
            var $ = layui.$,
                active = {
                    reload: function() {
                        // 获取上面查询框的值
                        var userName = $('#userName'); // 所属商户
                        var orderId = $('#orderId'); // 订单编号
                        var operatorNumber = $('#operatorNumber'); // 经销商名称
                        var startTime = $('#startTime');
                        var endTime = $('#endTime');
                        var transactionType = $('#transactionType'); // 支付方式
                        var salesNumber = $('#salesNumber'); // 业务员

                        //执行重载
                        table.reload('billlist', {
                            page: {
                                curr: 1 //重新从第 1 页开始
                            },
                            where: {
                                userName: userName.val().trim(),
                                orderId: orderId.val().trim(),
                                operatorNumber: operatorNumber.val(),
                                startTime: startTime.val(),
                                endTime: endTime.val(),
                                transactionType: transactionType.val(),
                                salesNumber: salesNumber.val()
                            }
                        });
                    }
                };

            //监听工具条
            table.on('tool(bill)', function(obj) {
                var data = obj.data;
                if (obj.event === 'detail') {
                    console.log(data)
                    // 跳转流水详情页面
                    layer.open({
                        type: 2,
                        title: '订单详情',
                        area: ['40%', '80%'], //宽高
                        content: 'dealersBillFailDetail.html',
                        success: function(layero, index) {
                            // 获取子页面的iframe
                            var iframe = window['layui-layer-iframe' + index];
                            // 向子页面的全局函数child传参
                            iframe.subPagebill(data)
                        }
                    });
                } else if (obj.event === 'instep') {
                    // 同步流水
                    layer.confirm('确定要同步流水吗', {
                        btn: ['确定', '取消'] //按钮
                    }, function() {
                        console.log(data)
                    })
                }
            });

            $('.layui-row .layui-btn').on('click', function() {
                var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });
        });
    }
    // 选择日期插件
    </script>
    <script type="text/javascript">
    $("input").focus(function() {
        $(this).parent().children(".layui-input-clear").show();
    });
    $("input").blur(function() {
        if ($(this).val() == '') {
            $(this).parent().children(".layui-input-clear").hide();
        }
    });
    $(".layui-input-clear").click(function() {
        $(this).parent().find('input').val('');
        $(this).hide();
    });
    </script>
</body>

</html>