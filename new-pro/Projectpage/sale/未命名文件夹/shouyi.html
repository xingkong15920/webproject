<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title></title>
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=1, user-scalable=0">
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <link rel="stylesheet" href="../../public/css/xadmin.css">
    <script type="text/javascript" src="../../public/js/jquery-3.2.1.js"></script>
    <link rel="stylesheet" href="../../public/css/style-baobiao.css">
    <script type="text/javascript" src="../../public/lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../public/js/xadmin.js"></script>
    <style>
    /* *{
                font-size: 14px;
            } */
    /* .layui-table-cell {
                height: auto;
                line-height: initial;
            } */
    .layui-table-cell {
        height: auto;
    }
    </style>
    <style type="text/css">
    .index-zs .layui-col-md5 {
        width: 20%;
        text-align: center;
    }

    .homelistitle {
        font-size: 1.2rem;
        margin-bottom: 10px;
        color: #999;
    }

    .homelistc:last-child {
        margin-bottom: 20px;
    }

    .homelistc {
        font-size: 1.6rem;
        font-weight: 600;
    }

    .homelistc span {
        display: block;
        font-size: 1.6rem;
        font-weight: 600;
    }

    .homelistc span i {
        font-style: normal;
        font-size: 1.6rem;
        font-weight: 600;
    }

    p {
        font-size: 16px;
    }
    </style>
</head>

<body>
    <div class="x-nav">
        <!-- <span class="layui-breadcrumb">
            <a href="">首页</a>
            <a><cite></cite></a>
        </span> -->
        <a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right" href="javascript:location.replace(location.href);" title="刷新">
            <i class="layui-icon" style="line-height:30px">ဂ</i></a>
    </div>
    <div class="x-body">
        <div class="layui-form layui-row">
            <div class="layui-input-inline">
                <input type="text" class="layui-input" placeholder="开始时间" name="startTime" id="startTime">
            </div>
            <div class="layui-input-inline">
                <input type="text" class="layui-input" placeholder="结束" name="endTime" id="endTime">
            </div>
            <button class="layui-btn" id="search"><i class="layui-icon">&#xe615;</i></button>
        </div>
        <div class="baobiao" style="width:100%;height:143px">
            <div class="baobiao-col-1" style="padding-left: 0;">
                <div class="baobiaoK">
                    <div class="baobiaolist" style="line-height:52px;font-size:16px">
                        交易总笔数
                    </div>
                    <div style="line-height:50px;font-size:16px" id="totalCount">
                        0
                    </div>
                </div>
            </div>
            <div class="baobiao-col-1 jianhao" style="padding-right:0;position:relative">
                <div class="baobiaoK">
                    <div class="baobiaolist" style="line-height:52px;font-size:16px">
                        交易总金额
                    </div>
                    <div style="line-height:50px;font-size:16px" id="orderTotalMoney">
                        0元
                    </div>
                </div>
            </div>
            <div class="baobiao-col-1 jianhao" style="padding-right: 0;">
                <div class="baobiaoK">
                    <div class="baobiaolist" style="line-height:52px;font-size:16px">
                        退款总笔数
                    </div>
                    <div style="line-height:50px;font-size:16px" id="refundTotalCount">
                        0
                    </div>
                </div>
            </div>
            <div class="baobiao-col-1 jianhao" style="padding-right: 0;">
                <div class="baobiaoK">
                    <div class="baobiaolist" style="line-height:52px;font-size:16px">
                        退款总金额
                    </div>
                    <div style="line-height:50px;font-size:16px" id="refundTotalMoney">
                        0元
                    </div>
                </div>
            </div>
            <div class="baobiao-col-1 denghao" style="padding-right: 0;">
                <div class="baobiaoK">
                    <div class="baobiaolist" style="line-height:52px;font-size:16px">
                        手续费
                    </div>
                    <div style="line-height:50px;font-size:16px" id="poundage">
                        0元
                    </div>
                </div>
            </div>
            <div class="baobiao-col-1 denghao" style="padding-right: 0;">
                <div class="baobiaoK">
                    <div class="baobiaolist" style="line-height:52px;font-size:16px">
                        交易实收
                    </div>
                    <div style="line-height:50px;font-size:16px" id="income">
                        0元
                    </div>
                </div>
            </div>
            <div class="baobiao-col-1 denghao" style="padding-right: 0;">
                <div class="baobiaoK">
                    <div class="baobiaolist" style="line-height:52px;font-size:16px">
                        订单均价
                    </div>
                    <div style="line-height:50px;font-size:16px" id="junjia">
                        0元
                    </div>
                </div>
            </div>
            <div class="baobiao-col-1 denghao" style="padding-right: 0;">
                <div class="baobiaoK">
                    <div class="baobiaolist" style="line-height:52px;font-size:16px">
                        净收益
                    </div>
                    <div style="line-height:50px;font-size:16px" id="SettlementCountMoney">
                        0元
                    </div>
                </div>
            </div>
        </div>
		<xblock>
			<button class="layui-btn" id="baobiao"><i class="layui-icon"></i>报表</button>
		</xblock>
        <table class="layui-hide" id="LAY_table_bill" lay-filter="bill" style="font-size:14px"></table>
    </div>
    <script type="text/html" id="tool">
        <a class="layui-btn layui-btn-xs" lay-event="detail">查看</a>
            
        </script>
    <script src="../../common/config-agent.js"></script>
    <script src="../../common/utility.js"></script>
    <script>
    // <a class="layui-btn layui-btn-xs" lay-event="instep" style="margin-left:0">同步</a>
    var newData;

    function fun_date(aa) {
        var date1 = new Date(),
            time1 = date1.getFullYear() + "-" + (date1.getMonth() + 1) + "-" + date1.getDate(); //time1表示当前时间
        var date2 = new Date(date1);
        date2.setDate(date1.getDate() + aa);
        var time2 = date2.getFullYear() + "-" + (date2.getMonth() + 1) + "-" + date2.getDate();

        var a = time2.split('-')[0],
            b = time2.split('-')[1],
            c = time2.split('-')[2]
        if (b < 10) {
            b = 0 + b
        }
        if (c < 10) {
            c = 0 + c
        }
        return a + '-' + b + '-' + c
    }
	
	function verTime() {
		var arr1 = $('#startTime').val().split('-');
		var arr2 = $('#endTime').val().split('-');
		arr1[1] = parseInt(arr1[1]);
		arr1[2] = parseInt(arr1[2]);
		arr2[1] = parseInt(arr2[1]);
		arr2[2] = parseInt(arr2[2]);
		var flag = true;
		if (arr1[0] == arr2[0]) { //同年
			if (arr2[1] - arr1[1] > 3) { //月间隔超过3个月
				flag = false;
			} else if (arr2[1] - arr1[1] == 3) { //月相隔3个月，比较日
				if (arr2[2] > arr1[2]) { //结束日期的日大于开始日期的日
					flag = false;
				}
			}
		} else { //不同年
			if (arr2[0] - arr1[0] > 1) {
				flag = false;
			} else if (arr2[0] - arr1[0] == 1) {
				if (arr1[1] < 10) { //开始年的月份小于10时，不需要跨年
					flag = false;
				} else if (arr1[1] + 3 - arr2[1] < 12) { //月相隔大于3个月
					flag = false;
				} else if (arr1[1] + 3 - arr2[1] == 12) { //月相隔3个月，比较日
					if (arr2[2] > arr1[2]) { //结束日期的日大于开始日期的日
						flag = false;
					}
				}
			}
		}
		if (!flag) {
			return false;
		} else {
			return true;
		}
	}

    function changeList(data) {
        var dataL = data.transactionReceiptShareProfitList
        for (var i = 0; i < dataL.length; i++) {
            if (dataL[i].orderState == 1) {
                dataL[i].orderState1 = "交易成功"
            }
            if (dataL[i].orderState == 2) {
                dataL[i].orderState1 = "已结算"
            }
            if (dataL[i].orderState == 3) {
                dataL[i].orderState1 = "失败"
            }
            if (dataL[i].orderState == 4) {
                dataL[i].orderState1 = "全部退款"
            }
            if (dataL[i].orderState == 5) {
                dataL[i].orderState1 = "部分退款"
            }
            if (dataL[i].orderState == 6) {
                dataL[i].orderState1 = "异常订单"
            }
            if (dataL[i].orderState == 7) {
                dataL[i].orderState1 = "退款中"
            }

        }
        console.log(data)
        newData = data.agentOrderList
        return dataL
    }
    window.onload = function() {
        var beginDate = fun_date(-6);

        var endDate = fun_date(0);
        layui.use(['table', 'laytpl', 'laydate'], function() {

            var table = layui.table,
                form = layui.form,
                laydate = layui.laydate
            laytpl = layui.laytpl,
                $ = layui.jquery;

            laydate.render({
                elem: '#startTime', //指定元素
                value: beginDate
            });
            laydate.render({
                elem: '#endTime',
                value: endDate
            });
            console.log()

            var userNumber = JSON.parse(sessionStorage.getItem('agentUser')).Number;
            var agentLevel = JSON.parse(sessionStorage.getItem('agentUser')).agentLevel;
            //方法级渲染
            console.log($('#startTime').val())
			
			$('#baobiao').click(function() {
				if ($('#billType').val() == 0 || $('#billType').val() == 3) {
					if (!verTime()) {
						layer.msg('只能查询三个月以内数据')
						return
					}
				}
				var newData = new Object()
				newData.institutionNumber = JSON.parse(sessionStorage.getItem('agentUser')).institutionNumber
				newData.agentNumber = JSON.parse(sessionStorage.getItem('agentUser')).Number
				newData.agentLevel = JSON.parse(sessionStorage.getItem('agentUser')).agentLevel
				newData.startTime = $('#startTime').val()
				newData.endTime = $('#endTime').val()
				newData.billType = $('#billType').val()
				layer.open({
					type: 2,
					title: '下载报表',
					shade: 0.5,
					area: ['500px', '270px'],
					maxmin: false,
					resize: false,
					content: ['down-excel.html'],
					success: function(layero, index) {
						// 获取子页面的iframe
						var iframe = window['layui-layer-iframe' + index];
						// 向子页面的全局函数child传w参
						iframe.subPage(newData, '3')
					}
				});
			})

            function tableRender() {
                CmsUtility.postAjaxCall(
                    //系统设置
                    'agentBill/getAgentIncomeDetails', {
                        "startTime": $('#startTime').val(),
                        "endTime": $('#endTime').val(),
                        "agentNumber": userNumber,
                        "agentLevel": agentLevel
                    },
                    function(data) {

                        if (data.code == 1000) {
                            $("#totalCount").html(data.data.agentBillMap[0].totalCount)
                            $("#orderTotalMoney").html(data.data.agentBillMap[0].orderTotalMoney + '元')
                            $("#refundTotalMoney").html(data.data.agentBillMap[0].refundTotalMoney + '元')
                            $("#refundTotalCount").html(data.data.agentBillMap[0].refundTotalCount)
                            $("#poundage").html(data.data.agentBillMap[0].poundage + '元')
                            $("#income").html(data.data.agentBillMap[0].income + '元')
                            $("#junjia").html((parseFloat(data.data.agentBillMap[0].orderTotalMoney)/parseFloat()).toFixed(2) + '元')
                            $("#SettlementCountMoney").html(data.data.agentBillMap[0].SettlementCountMoney + '元')

                        } else {
                            $("#totalCount").html('0')
                            $("#orderTotalMoney").html('0')
                            $("#refundTotalMoney").html('0')
                            $("#refundTotalCount").html('0')
                            $("#poundage").html('0')
                            $("#income").html('0')
                            $("#junjia").html('0')
                            $("#SettlementCountMoney").html('0')
                            layer.msg(data.msg)
                        }
                    },
                    function(data) {
                        console.log('222')
                    }
                )
                var index = layer.load(2, { shade: [0.4, '#393D49'] })
                table.render({
                    url: CmsConfig.ServiceUrl.ApiRootUrl + 'agentBill/getMerDetailList' + '?agentNumber=' + userNumber,
                    where: {
                        "agentLevel": agentLevel,
                        "startTime": $('#startTime').val(),
                        "endTime": $('#endTime').val(),
                    },
                    elem: '#LAY_table_bill',
                    page: true,
                    height: 'full-200',
                    id: 'billlist',
                    response: {
                        "statusCode": "1000", //解析接口状态
                    },
                    parseData: function(res) {
                        if (res.data == null) {
                            return
                        }
                        return {
                            "msg": res.msg,
                            "code": res.code,
                            "count": res.data.count,
                            "data": res.data.agentBillList,
                        }
                    },
                    cols: [
                        [{
                            title: '交易日期',
                            align: 'center',
                            field:'Statement_Date',
                            width:120
                        }, {
                            
                            title: '商户数量' ,
                            align: 'center',
                            field:'merCount',
                            width:85,
                        }, {
                            field: 'dxMercount',
                            title: '动销商户数量',
                            align: 'center',
                            width:85,
                        }, {
                            field: 'shopPoundage',
                            title: '合计' + '</br>' + '总笔数/总金额/总收益',
                            align: 'center',
                            templet: function(data) {
                                return  data.transactionNumber + ' / ￥' + data.transactionMoney + ' / ￥' + data.transactionSYMoney
                            },
                            width:150
                        }, {
                            field: 'shopPoundage',
                            title: '微信(交易通道)' + '</br>' + '总笔数/总金额/总收益',
                            align: 'center',
                            templet: function(data) {
                                return  data.wTransactionNumber + ' / ￥' + data.wTransactionMoney + ' / ￥' + data.wTransactionSYMoney
                            }
                        }
                        , {
                            field: 'shopPoundage',
                            title: '支付宝(交易通道)' + '</br>' + '总笔数/总金额/总收益',
                            align: 'center',
                            templet: function(data) {
                                return  data.zTransactionNumber + ' / ￥' + data.zTransactionMoney + ' / ￥' + data.zTransactionSYMoney
                            }
                        }, {
                            field: 'shopPoundage',
                            title: '云闪付' + '</br>' + '总笔数/总金额/总收益',
                            align: 'center',
                            templet: function(data) {
                                return  data.zTransactionNumber + ' / ￥' + data.zTransactionMoney + ' / ￥' + data.zTransactionSYMoney
                            }
                        }, {
                            field: 'shopPoundage',
                            title: '富友' + '</br>' + '总笔数/总金额/总收益',
                            align: 'center',
                            templet: function(data) {
                                return  data.fytransactionNumber + ' / ￥' + data.fytransactionMoney + ' / ￥' + data.fytransactionfrMoney
                            }
                        }, {
                            field: 'shopPoundage',
                            title: '新大陆' + '</br>' + '总笔数/总金额/总收益',
                            align: 'center',
                            templet: function(data) {
                                return  data.xdltransactionNumber + ' / ￥' + data.xdltransactionMoney + ' / ￥' + data.xdltransactionfrMoney
                            }
                        }
                        , {
                            field: 'shopPoundage',
                            title: '易融码' + '</br>' + '总笔数/总金额/总收益',
                            align: 'center',
                            templet: function(data) {
                                return  data.yrmtransactionNumber + ' / ￥' + data.yrmtransactionMoney + ' / ￥' + data.yrmtransactionfrMoney
                            }
                        } , {
                            field: 'shopPoundage',
                            title: '随行付' + '</br>' + '总笔数/总金额/总收益',
                            align: 'center',
                            templet: function(data) {
                                return  data.sxftransactionNumber + ' / ￥' + data.sxftransactionMoney + ' / ￥' + data.sxftransactionfrMoney
                            }
                        } , {
                            field: 'shopPoundage',
                            title: '乐刷' + '</br>' + '总笔数/总金额/总收益',
                            align: 'center',
                            templet: function(data) {
                                return  data.lstransactionNumber + ' / ￥' + data.lstransactionMoney + ' / ￥' + data.lstransactionfrMoney
                            }
                        }
                        ]
                    ],
                    done: function(res, curr, count) {
                        // console.log(newData)
                        // console.log(curr)
                        



                        layer.closeAll()
                    }
                });
            }
            setTimeout(function() {
                tableRender()
            }, 500)

            $('#search').click(function() {
                tableRender()
            })
            // 根據條件重载表格
            var $ = layui.$,
                active = {
                    reload: function() {
                        // 获取上面查询框的值
                        var userName = $('#userName'); // 所属商户
                        var orderId = $('#orderId'); // 订单编号
                        var operatorNumber = $('#operatorNumber'); // 经销商名称
                        var startTime = $('#startTime');
                        var endTime = $('#endTime');
                        var transactionType = $('#transactionType'); // 支付方式
                        var salesNumber = $('#salesNumber'); // 业务员

                        //执行重载
                        table.reload('billlist', {
                            page: {
                                curr: 1 //重新从第 1 页开始
                            },
                            where: {
                                userName: userName.val().trim(),
                                orderId: orderId.val().trim(),
                                operatorNumber: operatorNumber.val(),
                                startTime: startTime.val(),
                                endTime: endTime.val(),
                                transactionType: transactionType.val(),
                                salesNumber: salesNumber.val()
                            }
                        });
                    }
                };

            //监听工具条
            table.on('tool(bill)', function(obj) {
                var data = obj.data;
                if (obj.event === 'detail') {
                    console.log(data)
                    // 跳转流水详情页面
                    layer.open({
                        type: 2,
                        title: '订单详情',
                        area: ['40%', '80%'], //宽高
                        content: 'dealersBillDetail.html',
                        success: function(layero, index) {
                            // 获取子页面的iframe
                            var iframe = window['layui-layer-iframe' + index];
                            // 向子页面的全局函数child传参
                            iframe.subPagebill(data)
                        }
                    });
                } else if (obj.event === 'instep') {
                    // 同步流水
                    layer.confirm('确定要同步流水吗', {
                        btn: ['确定', '取消'] //按钮
                    }, function() {
                        console.log(data)
                    })
                }
            });

            $('.layui-row .layui-btn').on('click', function() {
                var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });
        });
    }
    // 选择日期插件
    </script>
    <script type="text/javascript">
    $("input").focus(function() {
        $(this).parent().children(".layui-input-clear").show();
    });
    $("input").blur(function() {
        if ($(this).val() == '') {
            $(this).parent().children(".layui-input-clear").hide();
        }
    });
    $(".layui-input-clear").click(function() {
        $(this).parent().find('input').val('');
        $(this).hide();
    });
    </script>
</body>

</html>