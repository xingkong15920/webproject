<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title></title>
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=1, user-scalable=0">
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <link rel="stylesheet" href="../../public/css/xadmin.css">
    <link rel="stylesheet" href="../../public/css/style-baobiao1.css">
    <script type="text/javascript" src="../../public/js/jquery-3.2.1.js"></script>
    <script type="text/javascript" src="../../public/lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../public/js/xadmin.js"></script>
    <script type="text/javascript">
    // $(function() {
    // 	$.ajax({
    // 		type: 'POST',
    // 		async: true,
    // 		url: ".getqudao",
    // 		success: function(data) {
    // 			for(var i = 0; i < data.length; i++) {
    // 				$("#payment").append("<option value='" + data[i].Passageway + "'>" + data[i].PassagewayC + "</option>");
    // 			}
    // 			form.render();
    // 		}
    // 	});
    // })
    </script>
    <style type="text/css">
    .clearfix:after {
        display: block;
        content: "";
        clear: both;
    }
    </style>
</head>

<body>
    <div class="x-nav">
        <span class="layui-breadcrumb">
				<a href="">首页</a>
				<a><cite>销售统计</cite></a>
			</span>
        <a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right" href="javascript:location.replace(location.href);" title="刷新">
				<i class="layui-icon" style="line-height:30px">ဂ</i></a>
    </div>
    <div class="x-body">
         <!-- <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend style="font-weight: 500;">筛选</legend>
            </fieldset> -->
        
        <div class="layui-row layui-col-space30" style="margin-top:30px">
            <!--汇总-->
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend style="font-weight: 500;">商户展示</legend>
            </fieldset>
            <!--报表-->
            <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
                <div class="grid-demo border">
                    <div class="">
                        <p class="x-red" style="font-size: 20px;margin-bottom: 15px;">新增商户</p>
                        <div class="grid-demo border" style="width:100%;overflow:auto">
                            <div id="main" style="height: 300px;width:100%"></div>
                            <div id="newCount" style="display:none;width:100%;text-align:center">暂没有新增商户</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
                <div class="grid-demo border">
                    <div class="">
                        <p class="x-red" style="font-size: 20px;margin-bottom: 15px;">全部商户 </p>
                        <div class="grid-demo border" style="width:100%;overflow:auto">
                            <div id="main1" style="height: 300px;width:100%"></div>
                            <div id="newCount1" style="display:none;width:100%;text-align:center">暂无数据</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
          <div class="layui-row layui-col-space30">
            <!--汇总-->
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend style="font-weight: 500;">交易展示</legend>
            </fieldset>
            <!--报表-->
            <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
                <div class="grid-demo border">
                    <div class="">
                        <p class="x-red" style="font-size: 20px;margin-bottom: 15px;">交易金额</p>
                        <div class="grid-demo border" style="width:100%;overflow:auto">
                            <div id="main2" style="height: 300px;width:100%"></div>
                            <div id="newCount2" style="display:none;width:100%;text-align:center">暂无数据</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
                <div class="grid-demo border">
                    <div class="">
                        <p class="x-red" style="font-size: 20px;margin-bottom: 15px;">交易笔数 </p>
                        <div class="grid-demo border" style="width:100%;overflow:auto">
                            <div id="main3" style="height: 300px;width:100%"></div>
                             <div id="newCount3" style="display:none;width:100%;text-align:center">暂无数据</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend style="font-weight: 500;">商户统计</legend>
            </fieldset>
        <div class="layui-row layui-form x-so" style="margin-bottom:20px;">
            <div class="layui-input-inline">
                <input type="text" name="shopname" id="shopName" placeholder="销售名称" autocomplete="off" class="layui-input">
            </div>
            <!--                <div class="layui-input-inline">
                    <select name="payment" id="transactionPayment" lay-search="">
                        <option value="">所属服务商</option>
                    </select>
                </div> -->
            <div class="layui-input-inline">
                <input type="text" class="layui-input" placeholder="开始时间" name="" id="startTime">
            </div>
            <div class="layui-input-inline">
                <input type="text" class="layui-input" placeholder="截止时间" name="" id="endTime">
            </div>
            <div class="layui-input-inline">
                <button class="layui-btn" lay-submit="" lay-filter="sreach" title="搜索" id="btn1"><i class="layui-icon">&#xe615;</i></button>
            </div>
        </div>
        <table class="layui-table" id="table1" lay-filter="useruv"></table>
    </div>
</body>
<script src="../../common/config-agent.js"></script>
<script src="../../common/utility.js"></script>
<script type="text/javascript" src="../../public/js/echarts.min.js"></script>
<script>
    //新增商户
            var myChart = echarts.init(document.getElementById('main'));
            var shCount = []
            var myChart1 = echarts.init(document.getElementById('main1'));
            var shCount1 = []
            var myChart2 = echarts.init(document.getElementById('main2'));
            var shCount2 = []
            var myChart3 = echarts.init(document.getElementById('main3'));
            var shCount3 = []
            function fun_date(aa){
               var date1 = new Date(),
                    time1 = date1.getFullYear() + "-" + (date1.getMonth() + 1) + "-" + date1.getDate(); //time1表示当前时间
                var date2 = new Date(date1);
                date2.setDate(date1.getDate() + aa);
                var time2 = date2.getFullYear() + "-" + (date2.getMonth() + 1) + "-" + date2.getDate();

                var a = time2.split('-')[0],
                    b = time2.split('-')[1],
                    c = time2.split('-')[2]
                if (b < 10) {
                    b = 0 + b
                }
                if (c < 10) {
                    c = 0 + c
                }
                return a + '-' + b + '-' + c
            }
var userNumber = JSON.parse(sessionStorage.getItem('agentUser')).Number;
var agentLevel = JSON.parse(sessionStorage.getItem('agentUser')).agentLevel;

//echarts方法
var option = {
            title: {
                text: '',
                subtext: '',
                left: 'center'
            },
            tooltip: {
                trigger: 'item',
                formatter: "{a} <br/>{b} : {c} ({d}%)"
            },

            series: [{
                type: 'pie',
                radius: '65%',
                center: ['50%', '50%'],
                selectedMode: 'single',
                data: shCount,
                itemStyle: {
                    emphasis: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }]
        };
        var option1 = {
            title: {
                text: '',
                subtext: '',
                left: 'center'
            },
            tooltip: {
                trigger: 'item',
                formatter: "{a} <br/>{b} : {c} ({d}%)"
            },

            series: [{
                type: 'pie',
                radius: '65%',
                center: ['50%', '50%'],
                selectedMode: 'single',
                data: shCount1,
                itemStyle: {
                    emphasis: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }]
        };
        var option2 = {
            title: {
                text: '',
                subtext: '',
                left: 'center'
            },
            tooltip: {
                trigger: 'item',
                formatter: "{a} <br/>{b} : {c} ({d}%)"
            },

            series: [{
                type: 'pie',
                radius: '65%',
                center: ['50%', '50%'],
                selectedMode: 'single',
                data: shCount2,
                itemStyle: {
                    emphasis: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }]
        };
        var option3 = {
            title: {
                text: '',
                subtext: '',
                left: 'center'
            },
            tooltip: {
                trigger: 'item',
                formatter: "{a} <br/>{b} : {c} ({d}%)"
            },

            series: [{
                type: 'pie',
                radius: '65%',
                center: ['50%', '50%'],
                selectedMode: 'single',
                data: shCount3,
                itemStyle: {
                    emphasis: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }]
        };
//列表

layui.use(['form', 'table', 'laytpl','laydate'], function() {
    var table = layui.table,
        form = layui.form,
        laytpl = layui.laytpl,
        laydate = layui.laydate;
        $ = layui.jquery;
    // 
     laydate.render({
        elem: '#startTime', //指定元素
        value: fun_date(-6)

    });
    laydate.render({
        elem: '#endTime',
        value: fun_date(0)
    });
    //新增商户
        // function newShopCount() {
        //     // ddDate = []
        //     // ddData = []
        //     for (let i = 0; i < shCount.length; i++) {
        //         shCount.splice(i)
        //     }
        //     CmsUtility.postAjaxCall(
        //         //系统设置
        //         'saleStatistics/getMerchantAllAndXz', {
        //             "agentNumber": userNumber,
        //             "saleName": $('#shopName').val(),
        //             "startTime": $('#startTime').val(),
        //             "endTime":$('#endTime').val(),
        //             "page": 1,
        //             "limit": 10
        //         },
        //         function(data) {

        //             if (data.code == 1000) {
        //                 var res = data.data
        //                 // shCount = []
        //                 for (var j = 0; j < res.length; j++) {
        //                     var newO = new Object()
        //                     newO.name = res[j].saleName
        //                     newO.value = res[j].merNewCount
        //                     shCount.push(newO)

        //                 }
        //                 // 为echarts对象加载数据
        //                 myChart.clear()
        //                 myChart.setOption(option, 'true');
        //             } else {
        //                 $('#main').hide()
        //                 $('#newCount').show()
                        
        //             }
        //         },
        //         function(data) {
        //             console.log('222')
        //         }
        //     )
        // }
        // newShopCount()
        //全部商户
        function allShopCount() {
            // ddDate = []
            // ddData = []
            for (let i = 0; i < shCount1.length; i++) {
                shCount1.splice(i)
            }
            for (let i = 0; i < shCount.length; i++) {
                shCount.splice(i)
            }
            CmsUtility.postAjaxCall(
                //系统设置
                'saleStatistics/getMerchantAllAndXz', {
                    "agentNumber": userNumber,
                    "saleName": $('#shopName').val(),
                    "startTime": $('#startTime').val(),
                    "endTime":$('#endTime').val(),
                    "page": 1,
                    "limit": 10
                },
                function(data) {

                    if (data.code == 1000) {
                        var res = data.data
                        // shCount = []
                        for (var j = 0; j < res.length; j++) {
                            if(res[j].merCount != 0){
                                var newO = new Object()
                                newO.name = res[j].saleName
                                newO.value = res[j].merCount
                                shCount1.push(newO)
                            }
                            

                        }
                        // 为echarts对象加载数据
                        myChart1.clear()
                        myChart1.setOption(option1, 'true');
                        if (data.code == 1000) {
                            var res = data.data
                            // shCount = []
                            for (var j = 0; j < res.length; j++) {
                                if(res[j].merNewCount != 0){
                                    var newO = new Object()
                                    newO.name = res[j].saleName
                                    newO.value = res[j].merNewCount
                                    shCount.push(newO)
                                }
                                

                            }
                            // 为echarts对象加载数据
                            myChart.clear()
                            myChart.setOption(option, 'true');
                        }
                        if(shCount.length == 0){

                                $('#main').hide()
                                $('#newCount').show()
                                
                            
                        }
                    } else {
                        $('#main1').hide()
                        $('#newCount1').show()
                        
                    }
                },
                function(data) {
                    console.log('222')
                }
            )
        }
        allShopCount()
        //交易金额
        function tradeMoney() {
            // ddDate = []
            // ddData = []
            for (let i = 0; i < shCount2.length; i++) {
                shCount2.splice(i)
            }
            for (let i = 0; i < shCount3.length; i++) {
                shCount3.splice(i)
            }
            CmsUtility.postAjaxCall(
                //系统设置
                'saleStatistics/getSaleMerTotalMoney', {
                    "agentNumber": userNumber,
                    "saleName": $('#shopName').val(),
                    "startTime": $('#startTime').val(),
                    "endTime":$('#endTime').val(),
                    "page": 1,
                    "limit": 10
                },
                function(data) {

                    if (data.code == 1000) {
                        var res = data.data
                        // shCount = []
                        for (var j = 0; j < res.length; j++) {
                            var newO = new Object()
                            newO.name = res[j].saleName
                            newO.value = res[j].orderTotalMoney
                            shCount2.push(newO)

                        }
                        // 为echarts对象加载数据
                        myChart2.clear()
                        myChart2.setOption(option2, 'true');
                    } else {
                        $('#main2').hide()
                        $('#newCount2').show()
                        
                    }
                    if (data.code == 1000) {
                        var res = data.data
                        // shCount = []
                        for (var j = 0; j < res.length; j++) {
                            var newO = new Object()
                            newO.name = res[j].saleName
                            newO.value = res[j].totalOrder
                            shCount3.push(newO)

                        }
                        // 为echarts对象加载数据
                        console.log(shCount3)
                        myChart3.clear()
                        myChart3.setOption(option3, 'true');
                    } else {
                        $('#main3').hide()
                        $('#newCount3').show()
                        
                    }
                },
                function(data) {
                    console.log('222')
                }
            )
        }
        tradeMoney()
        //交易笔数
        // function tradeCount() {
        //     // ddDate = []
        //     // ddData = []
        //     for (let i = 0; i < shCount3.length; i++) {
        //         shCount3.splice(i)
        //     }
        //     CmsUtility.postAjaxCall(
        //         //系统设置
        //         'saleStatistics/getSaleMerTotalMoney', {
        //             "agentNumber": userNumber,
        //             "saleName": $('#shopName').val(),
        //             "startTime": $('#startTime').val(),
        //             "endTime":$('#endTime').val(),
        //             "page": 1,
        //             "limit": 10
        //         },
        //         function(data) {

        //             if (data.code == 1000) {
        //                 var res = data.data
        //                 // shCount = []
        //                 for (var j = 0; j < res.length; j++) {
        //                     var newO = new Object()
        //                     newO.name = res[j].saleName
        //                     newO.value = res[j].totalOrder
        //                     shCount3.push(newO)

        //                 }
        //                 // 为echarts对象加载数据
        //                 console.log(shCount3)
        //                 myChart3.clear()
        //                 myChart3.setOption(option3, 'true');
        //             } else {
        //                 $('#main3').hide()
        //                 $('#newCount3').show()
                        
        //             }
        //         },
        //         function(data) {
        //             console.log('222')
        //         }
        //     )
        // }
        // tradeCount()
    //方法级渲染
    function tableRender() {
        console.log($('#startTime').val() )
        table.render({
            elem: '#table1',
            url: CmsConfig.ServiceUrl.ApiRootUrl + 'saleStatistics/getSaleStatistics' + '?agentNumber=' + userNumber,
            where: {

                // "shopName": $('#shopName').val().trim(),
                "saleName": $('#shopName').val(),
                "startTime": $('#startTime').val() + ' 00:00:00',
                "endTime": $('#endTime').val()+ ' 23:59:59',
            },
            page: true,
            limits: [10, 20],
            method: "post",
            id: 'tradeInfo',
            response: {
                //res 即为原始返回的数据
                "statusCode": "1000", //解析接口状态

            },
            parseData: function(res) {
                console.log(res)
                //res 即为原始返回的数据
                if (res.data == null) {
                    return
                }
                return {
                    "code": res.code, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "count": res.data.count, //解析数据长度
                    "data": res.data.saleStatistics, //解析数据列表
                };
            },
            cols: [
                [{
                    field: 'saleName',
                    title: '销售名称',
                    align: 'center',
                    
                }, {
                    field: 'merchantNewCount',
                    title: '新增商户数',
                    align: 'center',
                    
                }, {
                    field: 'merchantCount',
                    title: '全部商户数',
                    align: 'center',
                    
                }, {
                    field: 'zhongshu',
                    title: '商户动销率(%)',
                    align: 'center'
                }, {
                    field: 'totalOrder',
                    title: '交易笔数',
                    align: 'center',
                    
                }, {
                    field: 'orderTotalMoney',
                    title: '交易金额',
                    align: 'center',
                    
                }, {
                    field: 'saleShareProfit',
                    title: '佣金',
                    align: 'center',
                   
                }]
            ]
        })
    }
    setTimeout(function(){
        $('#search').click(function() {
            tableRender()
        })
    },500)
    tableRender()
    
    $('#btn1').click(function() {
        console.log('111')
        tableRender()
        newShopCount()
allShopCount()
 tradeMoney()
tradeCount()
    })
    // 根據條件重载表格
    var $ = layui.$,
        active = {
            reload: function() {
                // 获取上面查询框的值
                var shopname = $("#shopname").val().trim();
                var startTime = $("#startTime").val().trim();
                var endTime = $("#endTime").val().trim();
                var passway = $("#payment option:selected").val().trim();
                //执行重载
                table.reload('tradeInfo', {
                    page: {
                        curr: 1 //重新从第 1 页开始
                    },
                    where: {
                        shopname: shopname,
                        passway: passway
                    }
                });
            }
        };

    $('.layui-row .layui-btn').on('click', function() {
        var type = $(this).data('type');
        active[type] ? active[type].call(this) : '';
    });
});
</script>
<script>
var beginDate = new Date();
if (beginDate.getMonth() == 1) {
    beginDate.setYear(beginDate.getYear() - 1);
    beginDate.setMonth(12);
} else {
    beginDate.setMonth(beginDate.getMonth() - 1);
}
var endDate = new Date();

// 选择日期插件  
layui.use('laydate', function() {
    var laydate = layui.laydate;
    laydate.render({
        elem: '#startTime', //指定元素


    });
    laydate.render({
        elem: '#endTime',


    });
    laydate.render({
        elem: '#startTime1', //指定元素
        value: new Date()

    });
    laydate.render({
        elem: '#endTime1',
        value: new Date()
    });
});
</script>
<script type="text/javascript">
function getShop() {

    layui.use(['table', 'layer', 'laydate'], function() {
        var table = layui.table,
            form = layui.form,
            laydate = layui.laydate
        laytpl = layui.laytpl,
            layer = layui.layer,
            $ = layui.jquery;
        var startTime = $("#startTime1").val();
        console.log(startTime)
        var endTime = $("#endTime1").val();
        var index = layer.load(2, { shade: [0.4, '#393D49'] })
        CmsUtility.postAjaxCall(
            //系统设置
            CmsConfig.addressUrl.Agent.selectMerchant, {
                "agentNumber": userNumber,
                "agentLevel": agentLevel,
                "startTime": startTime,
                "endtime": endTime,
            },
            function(data) {
                layer.closeAll()
                if (data.code == 1000) {
                    $('#shopCount').html(data.data.agShopStatisticsResult.shopCount)
                    $('#brokerage').html(data.data.agShopStatisticsResult.brokerage + '元')
                    $('#transactionNumber').html(data.data.agShopStatisticsResult.transactionNumber)
                    $('#wTransactionNumber').html(data.data.agShopStatisticsResult.wTransactionNumber)
                    $('#zTransactionNumber').html(data.data.agShopStatisticsResult.zTransactionNumber)
                    $('#transactionMoney').html(data.data.agShopStatisticsResult.transactionMoney)
                    $('#wTransactionMoney').html(data.data.agShopStatisticsResult.wTransactionMoney)

                    $('#zTransactionMoney').html(data.data.agShopStatisticsResult.zTransactionMoney)
                    $('#refundMoney').html(data.data.agShopStatisticsResult.refundMoney)
                    $('#wRefundMoney').html(data.data.agShopStatisticsResult.wRefundMoney)
                    $('#zRefundMoney').html(data.data.agShopStatisticsResult.zRefundMoney)
                    $('#poundage').html(data.data.agShopStatisticsResult.poundage)
                    $('#wpoundage').html(data.data.agShopStatisticsResult.wpoundage)
                    $('#zpoundage').html(data.data.agShopStatisticsResult.zpoundage)
                    $('#incomeMoney').html(data.data.agShopStatisticsResult.incomeMoney)
                    $('#wIncomeMoney').html(data.data.agShopStatisticsResult.wIncomeMoney)
                    $('#zIncomeMoney').html(data.data.agShopStatisticsResult.zIncomeMoney)
                } else {
                    layer.msg(data.msg)

                }
            },
            function(data) {
                console.log('222')
            }
        )

    })

}
getShop()
$("#btn").click(function() {
    getShop()
});
</script>

</html>